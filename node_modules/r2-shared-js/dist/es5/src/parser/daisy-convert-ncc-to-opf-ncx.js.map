{"version":3,"file":"daisy-convert-ncc-to-opf-ncx.js","sourceRoot":"","sources":["../../../../src/parser/daisy-convert-ncc-to-opf-ncx.ts"],"names":[],"mappings":"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","sourcesContent":["// ==LICENSE-BEGIN==\n// Copyright 2017 European Digital Reading Lab. All rights reserved.\n// Licensed to the Readium Foundation under one or more contributor license agreements.\n// Use of this source code is governed by a BSD-style license\n// that can be found in the LICENSE file exposed on Github (readium) in the project repository.\n// ==LICENSE-END==\n\nimport * as he from \"he\";\nimport * as debug_ from \"debug\";\nimport * as mime from \"mime-types\";\nimport * as path from \"path\";\nimport * as xmldom from \"@xmldom/xmldom\";\n\nimport { timeStrToSeconds } from \"@models/media-overlay\";\nimport { streamToBufferPromise } from \"@r2-utils-js/_utils/stream/BufferUtils\";\nimport { IStreamAndLength, IZip } from \"@r2-utils-js/_utils/zip/zip\";\nimport { removeUTF8BOM } from \"@r2-utils-js/_utils/bom\";\n\nimport { zipHasEntry } from \"../_utils/zipHasEntry\";\nimport { getNcx_, getOpf_ } from \"./epub-daisy-common\"; // , loadFileStrFromZipPath\nimport { NCX } from \"./epub/ncx\";\nimport { OPF } from \"./epub/opf\";\n\nconst debug = debug_(\"r2:shared#parser/daisy-convert-to-epub\");\n\n// Removal of all encoding layers (two pass) is a reasonable approach for DAISY NCC HTML metadata and hyperlinks\n// (normally just one pass, but often authored with \"forced\" escaped chars despite unicode support on the consumer side)\n\n// Example ncc.html attribute value:\n// <element attribute=\" &nbsp;&quot; &amp;#39; -- &#39; == ' xxx &lt; yyy &gt; zzz &amp;lt; &amp; \" />\n// ...parsed by xmldom (all entities decoded):\n// [  \" &#39; -- ' == ' xxx < yyy > zzz &lt; & ]\n// ...he.decode() second pass:\n// [  \" ' -- ' == ' xxx < yyy > zzz < & ]\n// ...JSON serialise (trimmed):\n// \"property\": \"\\\" ' -- ' == ' xxx < yyy > zzz < &\"\nconst decodeHtmlAttributeValue = (val: string) => {\n    const decoded = he.decode(val, { isAttributeValue: true });\n    // if (val !== decoded) {\n    //     console.log(`====== decodeHtmlAttributeValue [${val}] ==> [${decoded}]`);\n    // }\n    return decoded;\n};\n// Example ncc.html text content:\n// <element> \" &nbsp;&quot; &amp;#39; -- &#39; == ' xxx &lt; yyy &gt; zzz &amp;lt; &amp; </element>\n// ...parsed by xmldom (all entities decoded):\n// [ \"  \" &#39; -- ' == ' xxx < yyy > zzz &lt; & ]\n// ...he.decode() second pass:\n// [ \"  \" ' -- ' == ' xxx < yyy > zzz < & ]\n// ...JSON serialise (trimmed):\n// \"property\": \"\\\"  \\\" ' -- ' == ' xxx < yyy > zzz < &\"\nconst decodeHtmlTextContent = (textContent: string) => {\n    const decoded = he.decode(textContent);\n    // if (textContent !== decoded) {\n    //     console.log(`====== decodeHtmlTextContent [${textContent}] ==> [${decoded}]`);\n    // }\n    return decoded;\n};\n\nconst encodeXmlAttributeValue = (val: string) => {\n    return val.replace(/\"/g, \"&quot;\"); // .replace(/'/g, \"&#39;\"); // &#39; == &apos;\n};\nconst encodeXmlTextContent = (textContent: string) => {\n    return textContent.replace(/&/g, \"&amp;\").replace(/</g, \"&lt;\").replace(/>/g, \"&gt;\");\n};\n\nconst getMediaTypeFromFileExtension = (ext: string) => {\n    if (/\\.smil$/i.test(ext)) {\n        return \"application/smil+xml\";\n    }\n\n    if (/\\.css$/i.test(ext)) {\n        return \"text/css\";\n    }\n\n    if (/\\.mp3$/i.test(ext)) {\n        return \"audio/mpeg\";\n    }\n\n    if (/\\.wav$/i.test(ext)) {\n        return \"audio/wav\";\n    }\n\n    if (/\\.jpe?g$/i.test(ext)) {\n        return \"image/jpeg\";\n    }\n\n    if (/\\.png$/i.test(ext)) {\n        return \"image/png\";\n    }\n\n    if (/\\.xml$/i.test(ext)) {\n        return \"application/x-dtbook+xml\";\n    }\n\n    if (/\\.html$/i.test(ext)) {\n        return \"text/html\";\n    }\n\n    if (/\\.xhtml$/i.test(ext)) {\n        return \"application/xhtml+xml\";\n    }\n\n    return mime.lookup(\"dummy\" + ext);\n};\n\nexport const convertNccToOpfAndNcx = async (\n    zip: IZip,\n    rootfilePathDecoded: string,\n    rootfilePath: string,\n): Promise<[OPF, NCX]> => {\n\n    const has = await zipHasEntry(zip, rootfilePathDecoded, rootfilePath);\n    if (!has) {\n        const err = `NOT IN ZIP (NCC.html): ${rootfilePath} --- ${rootfilePathDecoded}`;\n        debug(err);\n        const zipEntries = await zip.getEntries();\n        for (const zipEntry of zipEntries) {\n            if (zipEntry.startsWith(\"__MACOSX/\")) {\n                continue;\n            }\n            debug(zipEntry);\n        }\n        // eslint-disable-next-line @typescript-eslint/prefer-promise-reject-errors\n        return Promise.reject(err);\n    }\n\n    let nccZipStream_: IStreamAndLength;\n    try {\n        nccZipStream_ = await zip.entryStreamPromise(rootfilePathDecoded);\n    } catch (err) {\n        debug(err);\n        // eslint-disable-next-line @typescript-eslint/prefer-promise-reject-errors\n        return Promise.reject(err);\n    }\n    const nccZipStream = nccZipStream_.stream;\n\n    let nccZipData: Buffer;\n    try {\n        nccZipData = await streamToBufferPromise(nccZipStream);\n    } catch (err) {\n        debug(err);\n        // eslint-disable-next-line @typescript-eslint/prefer-promise-reject-errors\n        return Promise.reject(err);\n    }\n\n    let nccStr = removeUTF8BOM(nccZipData.toString(\"utf8\"));\n\n    // https://github.com/readium/r2-shared-js/commit/a83c8d6b56edb97bc2acc6889347274888feaecb#diff-ac9dbda3443005fb662618cf819db718d98b2361d98a4c39d574a6e5ddc3bda2\n    let nccDoc: Document | undefined;\n    try {\n        nccDoc = new xmldom.DOMParser().parseFromString(\n            nccStr,\n            // \"application/xml\",\n            \"text/html\",\n            // \"application/xhtml+xml\",\n        ) as unknown as Document;\n    } catch (err1) {\n        console.log(\"xmldom.DOMParser().parseFromString text/html ERROR1, attempting DOCTYPE fix...\");\n        console.log(err1);\n        // <!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\" []>\n        // console.log(nccStr.substring(0, 600));\n        nccStr = nccStr.replace(/(<!DOCTYPE\\s+[^>]+\\s*)\\[\\s*\\]\\s*>/, \"$1>\");\n        // console.log(nccStr.substring(0, 600));\n        try {\n            nccDoc = new xmldom.DOMParser().parseFromString(\n                nccStr,\n                // \"application/xml\",\n                \"text/html\",\n                // \"application/xhtml+xml\",\n            ) as unknown as Document;\n        } catch (err2) {\n            console.log(\"xmldom.DOMParser().parseFromString text/html ERROR2, fallback to application/xml...\");\n            console.log(err2);\n            nccDoc = new xmldom.DOMParser().parseFromString(\n                nccStr,\n                \"application/xml\",\n                // \"text/html\",\n                // \"application/xhtml+xml\",\n            ) as unknown as Document;\n        }\n    }\n\n    const metas = Array.from(nccDoc.getElementsByTagName(\"meta\")).\n        reduce((prevVal, curVal) => {\n            const name = curVal.getAttribute(\"name\");\n            const content = curVal.getAttribute(\"content\");\n            if (name && content) {\n                prevVal[name] = decodeHtmlAttributeValue(content.trim());\n            }\n            return prevVal;\n        }, {} as {[key: string]: string});\n\n    const aElems = Array.from(nccDoc.getElementsByTagName(\"a\"));\n\n    // TODO: textPartAudio / audioPartText?? audioOnly??\n    // https://www.daisy.org/z3986/specifications/Z39-86-2002.html#Type\n    // https://www.daisy.org/z3986/specifications/daisy_202.html\n    let multimediaContent = \"\";\n    let multimediaType = \"\";\n    if (metas[\"ncc:multimediaType\"] === \"audioFullText\" ||\n        metas[\"ncc:multimediaType\"] === \"audioNcc\" ||\n        metas[\"ncc:totalTime\"] && timeStrToSeconds(metas[\"ncc:totalTime\"]) > 0) {\n        if (metas[\"ncc:multimediaType\"] === \"audioFullText\" || !metas[\"ncc:multimediaType\"]) {\n            multimediaContent = \"audio,text,image\";\n            multimediaType = \"audioFullText\";\n        } else {\n            multimediaContent = \"audio,image\";\n            multimediaType = \"audioNCX\";\n        }\n    } else if (metas[\"ncc:multimediaType\"] === \"textNcc\" ||\n        metas[\"ncc:totalTime\"] && timeStrToSeconds(metas[\"ncc:totalTime\"]) === 0) {\n        multimediaContent = \"text,image\";\n        multimediaType = \"textNCX\";\n    }\n\n    const zipEntriez = (await zip.getEntries()).filter((e) => {\n        return e && !e.endsWith(\"/\"); // exclude folders!\n    });\n\n    const manifestItemsBaseStr = zipEntriez.reduce((pv, cv, ci) => {\n        const ext = path.extname(cv);\n        return `${pv}${!cv.startsWith(\"__MACOSX/\") && !/ncc\\.html$/i.test(cv) && !/\\.ent$/i.test(ext) && !/\\.dtd$/i.test(ext) && !/\\.smil$/i.test(ext) ? `\n        <item\n            href=\"${encodeXmlAttributeValue(path.relative(\"file:///\" + path.dirname(rootfilePathDecoded), \"file:///\" + cv).replace(/\\\\/g, \"/\"))}\"\n            id=\"opf-zip-${ci}\"\n            media-type=\"${getMediaTypeFromFileExtension(ext)}\" />` : \"\"}`;\n    }, \"\");\n    const arrSmils: string[] = [];\n    const manifestItemsStr = aElems.reduce((pv, cv, _ci) => {\n        const href = cv.getAttribute(\"href\");\n        if (!href) {\n            return pv;\n        }\n        if (!/\\.smil(#.*)?$/i.test(href)) {\n            return pv;\n        }\n\n        const smil = href.replace(/(.+\\.smil)(#.*)?$/i, \"$1\");\n        if (arrSmils.indexOf(smil) >= 0) {\n            return pv;\n        }\n        arrSmils.push(smil);\n\n        // const txt = cv.textContent ? cv.textContent.trim() : \"\";\n\n        return `${pv}${`\n            <item\n                href=\"${encodeXmlAttributeValue(smil)}\"\n                id=\"opf-ncc-${arrSmils.length - 1}\"\n                media-type=\"application/smil+xml\" />`}`;\n    }, manifestItemsBaseStr);\n\n    const spineItemsStr = arrSmils.reduce((pv, _cv, ci) => {\n        return `${pv}${`\n            <itemref idref=\"opf-ncc-${ci}\" />`}`;\n    }, \"\");\n\n    let playOrder = 0;\n    let pCount = 0;\n    const pageListStr = aElems.reduce((pv, cv, _ci) => {\n        const href = cv.getAttribute(\"href\");\n        if (!href) {\n            return pv;\n        }\n        if (!/\\.smil(#.*)?$/i.test(href)) {\n            return pv;\n        }\n        if (!cv.parentNode) {\n            return pv;\n        }\n        playOrder++;\n\n        const clazz = (cv.parentNode as Element).getAttribute(\"class\");\n        if (!clazz || !clazz.startsWith(\"page\")) {\n            return pv;\n        }\n\n        const txtContent = cv.textContent ? decodeHtmlTextContent(cv.textContent.trim()) : \"\";\n\n        pCount++;\n        return `${pv}${`\n<pageTarget class=\"pagenum\" id=\"ncx-p${pCount}\" playOrder=\"${playOrder}\" type=\"normal\" value=\"${pCount}\">\n<navLabel>\n<text>${txtContent ? encodeXmlTextContent(txtContent) : pCount}</text>\n</navLabel>\n<content src=\"${encodeXmlAttributeValue(href)}\"/>\n</pageTarget>\n`}`;\n    }, \"\");\n\n    playOrder = 0;\n    pCount = 0;\n    const navMapStr = aElems.reduce((pv, cv, _ci) => {\n        const href = cv.getAttribute(\"href\");\n        if (!href) {\n            return pv;\n        }\n        if (!/\\.smil(#.*)?$/i.test(href)) {\n            return pv;\n        }\n        if (!cv.parentNode) {\n            return pv;\n        }\n        playOrder++;\n\n        const name = (cv.parentNode as Element).localName;\n        if (!name || !name.startsWith(\"h\")) {\n            return pv;\n        }\n        const level = parseInt(name.substr(1), 10);\n\n        const txtContent = cv.textContent ? decodeHtmlTextContent(cv.textContent.trim()) : \"\";\n\n        pCount++;\n\n        const inner = `<!-- h${level-1}_${pCount-1} -->`;\n        if (pv.indexOf(inner) >= 0) {\n            return pv.replace(inner, `\n<navPoint class=\"${name}\" id=\"ncx-t${pCount}\" playOrder=\"${playOrder}\">\n<navLabel>\n<text>${txtContent ? encodeXmlTextContent(txtContent) : `_${pCount}`}</text>\n</navLabel>\n<content src=\"${encodeXmlAttributeValue(href)}\"/>\n<!-- ${name}_${pCount} -->\n</navPoint>\n<!-- h${level-1}_${pCount} -->\n`);\n        } else {\n            return `${pv}${`\n<navPoint class=\"${name}\" id=\"ncx-t${pCount}\" playOrder=\"${playOrder}\">\n<navLabel>\n<text>${txtContent ? encodeXmlTextContent(txtContent) : `_${pCount}`}</text>\n</navLabel>\n<content src=\"${encodeXmlAttributeValue(href)}\"/>\n<!-- ${name}_${pCount} -->\n</navPoint>\n`}`;\n        }\n    }, \"\");\n\n    const opfStr = `<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<!DOCTYPE package\nPUBLIC \"+//ISBN 0-9673008-1-9//DTD OEB 1.2 Package//EN\"\n\"http://openebook.org/dtds/oeb-1.2/oebpkg12.dtd\">\n<package xmlns=\"http://openebook.org/namespaces/oeb-package/1.0/\" unique-identifier=\"uid\">\n\n<metadata>\n<dc-metadata xmlns:dc=\"http://purl.org/dc/elements/1.1/\"\nxmlns:oebpackage=\"http://openebook.org/namespaces/oeb-package/1.0/\">\n    <dc:Format>ANSI/NISO Z39.86-2005</dc:Format>\n    ${metas[\"dc:date\"] ? `<dc:Date>${encodeXmlTextContent(metas[\"dc:date\"])}</dc:Date>` : \"\"}\n    ${metas[\"dc:language\"] ? `<dc:Language>${encodeXmlTextContent(metas[\"dc:language\"])}</dc:Language>` : \"\"}\n    ${metas[\"dc:creator\"] ? `<dc:Creator>${encodeXmlTextContent(metas[\"dc:creator\"])}</dc:Creator>` : \"\"}\n    ${metas[\"dc:publisher\"] ? `<dc:Publisher>${encodeXmlTextContent(metas[\"dc:publisher\"])}</dc:Publisher>` : \"\"}\n    ${metas[\"dc:title\"] ? `<dc:Title>${encodeXmlTextContent(metas[\"dc:title\"])}</dc:Title>` : \"\"}\n    ${metas[\"dc:identifier\"] ? `<dc:Identifier id=\"uid\">${encodeXmlTextContent(metas[\"dc:identifier\"])}</dc:Identifier>` : \"\"}\n</dc-metadata>\n\n<x-metadata>\n    ${metas[\"ncc:narrator\"] ? `<meta name=\"dtb:narrator\" content=\"${encodeXmlAttributeValue(metas[\"ncc:narrator\"])}\" />` : \"\"}\n    ${metas[\"ncc:totalTime\"] ? `<meta name=\"dtb:totalTime\" content=\"${encodeXmlAttributeValue(metas[\"ncc:totalTime\"])}\" />` : \"\"}\n\n    <meta name=\"dtb:multimediaType\" content=\"${encodeXmlAttributeValue(multimediaType)}\" />\n    <meta name=\"dtb:multimediaContent\" content=\"${encodeXmlAttributeValue(multimediaContent)}\" />\n\n    <!-- RAW COPY FROM DAISY2: -->\n    ${Object.keys(metas).reduce((pv, cv) => {\n        return `${pv}\n    <meta name=\"${cv}\" content=\"${encodeXmlAttributeValue(metas[cv])}\" />`;\n    }, \"\")}\n</x-metadata>\n\n</metadata>\n\n<manifest>\n<!-- item href=\"package.opf\" id=\"opf\" media-type=\"text/xml\" />\n<item href=\"navigation.ncx\" id=\"ncx\" media-type=\"application/x-dtbncx+xml\" / -->\n\n${manifestItemsStr}\n</manifest>\n\n<spine>\n${spineItemsStr}\n</spine>\n\n</package>`;\n\n    // debug(opfStr);\n    // if (process.env) {\n    //     throw new Error(\"BREAK\");\n    // }\n\n    const opf = getOpf_(opfStr, rootfilePathDecoded);\n\n    const ncxStr = `<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<ncx xmlns=\"http://www.daisy.org/z3986/2005/ncx/\" version=\"2005-1\">\n<head>\n    ${metas[\"dc:identifier\"] ? `<meta name=\"dtb:uid\" content=\"${encodeXmlAttributeValue(metas[\"dc:identifier\"])}\" />` : \"\"}\n    ${metas[\"ncc:generator\"] ? `<meta name=\"dtb:generator\" content=\"${encodeXmlAttributeValue(metas[\"ncc:generator\"])}\"/>` : \"\"}\n    ${metas[\"ncc:depth\"] ? `<meta name=\"dtb:depth\" content=\"${encodeXmlAttributeValue(metas[\"ncc:depth\"])}\"/>` : \"\"}\n    ${metas[\"ncc:pageNormal\"] ? `<meta name=\"dtb:totalPageCount\" content=\"${encodeXmlAttributeValue(metas[\"ncc:pageNormal\"])}\"/>` : \"\"}\n    ${metas[\"ncc:maxPageNormal\"] ? `<meta name=\"dtb:maxPageNumber\" content=\"${encodeXmlAttributeValue(metas[\"ncc:maxPageNormal\"])}\"/>` : \"\"}\n</head>\n\n<docTitle>\n<text>${metas[\"dc:title\"] ? encodeXmlTextContent(metas[\"dc:title\"]) : \"_\"}</text>\n</docTitle>\n\n<docAuthor>\n<text>${metas[\"dc:creator\"] ? encodeXmlTextContent(metas[\"dc:creator\"]) : \"-\"}</text>\n</docAuthor>\n\n<navMap id=\"navMap\">\n${navMapStr}\n</navMap>\n\n<pageList id=\"pageList\">\n${pageListStr}\n</pageList>\n\n</ncx>`;\n\n    // debug(ncxStr);\n    // if (process.env) {\n    //     throw new Error(\"BREAK\");\n    // }\n\n    const ncx = getNcx_(ncxStr, rootfilePathDecoded);\n\n    return [opf, ncx];\n};\n"]}