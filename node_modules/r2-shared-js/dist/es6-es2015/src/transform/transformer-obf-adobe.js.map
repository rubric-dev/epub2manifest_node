{"version":3,"file":"transformer-obf-adobe.js","sourceRoot":"","sources":["../../../../src/transform/transformer-obf-adobe.ts"],"names":[],"mappings":";;;;AASA,wEAA+F;AAK/F,MAAa,mBAAmB;IACrB,QAAQ,CAAC,YAAyB,EAAE,IAAU;QACjD,OAAO,IAAI,CAAC,UAAU,IAAI,IAAI,CAAC,UAAU,CAAC,SAAS;YAC/C,IAAI,CAAC,UAAU,CAAC,SAAS,CAAC,SAAS,KAAK,gCAAgC,CAAC;IACjF,CAAC;IAEY,eAAe,CACxB,WAAwB,EACxB,IAAU,EACV,IAAwB,EACxB,MAAwB,EACxB,0BAAmC,EACnC,iBAAyB,EACzB,eAAuB,EACvB,YAAgC;;YAGhC,IAAI,IAAY,CAAC;YACjB,IAAI,CAAC;gBACD,IAAI,GAAG,MAAM,IAAA,mCAAqB,EAAC,MAAM,CAAC,MAAM,CAAC,CAAC;YACtD,CAAC;YAAC,OAAO,GAAG,EAAE,CAAC;gBAEX,OAAO,OAAO,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC;YAC/B,CAAC;YAED,IAAI,IAAY,CAAC;YACjB,IAAI,CAAC;gBACD,IAAI,GAAG,MAAM,IAAI,CAAC,eAAe,CAAC,WAAW,EAAE,IAAI,EAAE,IAAI,CAAC,CAAC;YAC/D,CAAC;YAAC,OAAO,GAAG,EAAE,CAAC;gBAEX,OAAO,OAAO,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC;YAC/B,CAAC;YAED,MAAM,GAAG,GAAqB;gBAC1B,MAAM,EAAE,IAAI,CAAC,MAAM;gBACnB,KAAK,EAAE,GAAS,EAAE;oBACd,OAAO,OAAO,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC;gBAChC,CAAC,CAAA;gBACD,MAAM,EAAE,IAAA,4BAAc,EAAC,IAAI,CAAC;aAC/B,CAAC;YACF,OAAO,OAAO,CAAC,OAAO,CAAC,GAAG,CAAC,CAAC;QAChC,CAAC;KAAA;IAEa,eAAe,CAAC,WAAwB,EAAE,KAAW,EAAE,IAAY;;YAE7E,IAAI,KAAK,GAAG,WAAW,CAAC,QAAQ,CAAC,UAAU,CAAC;YAC5C,KAAK,GAAG,KAAK,CAAC,OAAO,CAAC,WAAW,EAAE,EAAE,CAAC,CAAC;YACvC,KAAK,GAAG,KAAK,CAAC,OAAO,CAAC,IAAI,EAAE,EAAE,CAAC,CAAC;YAChC,KAAK,GAAG,KAAK,CAAC,OAAO,CAAC,KAAK,EAAE,EAAE,CAAC,CAAC;YAEjC,MAAM,GAAG,GAAG,EAAE,CAAC;YACf,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,EAAE,EAAE,CAAC,EAAE,EAAE,CAAC;gBAC1B,MAAM,OAAO,GAAG,KAAK,CAAC,MAAM,CAAC,CAAC,GAAG,CAAC,EAAE,CAAC,CAAC,CAAC;gBACvC,MAAM,SAAS,GAAG,QAAQ,CAAC,OAAO,EAAE,EAAE,CAAC,CAAC;gBACxC,GAAG,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC;YACxB,CAAC;YAED,MAAM,YAAY,GAAG,IAAI,CAAC;YAC1B,MAAM,aAAa,GAAG,IAAI,CAAC,KAAK,CAAC,CAAC,EAAE,YAAY,CAAC,CAAC;YAElD,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,YAAY,EAAE,CAAC,EAAE,EAAE,CAAC;gBAEpC,aAAa,CAAC,CAAC,CAAC,GAAG,aAAa,CAAC,CAAC,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC,GAAG,GAAG,CAAC,MAAM,CAAC,CAAC,CAAC;YAChE,CAAC;YAED,MAAM,gBAAgB,GAAG,IAAI,CAAC,KAAK,CAAC,YAAY,CAAC,CAAC;YAClD,OAAO,OAAO,CAAC,OAAO,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC,aAAa,EAAE,gBAAgB,CAAC,CAAC,CAAC,CAAC;QAC7E,CAAC;KAAA;CA2BJ;AA9FD,kDA8FC","sourcesContent":["// ==LICENSE-BEGIN==\n// Copyright 2017 European Digital Reading Lab. All rights reserved.\n// Licensed to the Readium Foundation under one or more contributor license agreements.\n// Use of this source code is governed by a BSD-style license\n// that can be found in the LICENSE file exposed on Github (readium) in the project repository.\n// ==LICENSE-END==\n\nimport { Publication } from \"@models/publication\";\nimport { Link } from \"@models/publication-link\";\nimport { bufferToStream, streamToBufferPromise } from \"@r2-utils-js/_utils/stream/BufferUtils\";\nimport { IStreamAndLength } from \"@r2-utils-js/_utils/zip/zip\";\n\nimport { ITransformer } from \"./transformer\";\n\nexport class TransformerObfAdobe implements ITransformer {\n    public supports(_publication: Publication, link: Link): boolean {\n        return link.Properties && link.Properties.Encrypted &&\n            link.Properties.Encrypted.Algorithm === \"http://ns.adobe.com/pdf/enc#RC\";\n    }\n\n    public async transformStream(\n        publication: Publication,\n        link: Link,\n        _url: string | undefined,\n        stream: IStreamAndLength,\n        _isPartialByteRangeRequest: boolean,\n        _partialByteBegin: number,\n        _partialByteEnd: number,\n        _sessionInfo: string | undefined,\n    ): Promise<IStreamAndLength> {\n\n        let data: Buffer;\n        try {\n            data = await streamToBufferPromise(stream.stream);\n        } catch (err) {\n            // eslint-disable-next-line @typescript-eslint/prefer-promise-reject-errors\n            return Promise.reject(err);\n        }\n\n        let buff: Buffer;\n        try {\n            buff = await this.transformBuffer(publication, link, data);\n        } catch (err) {\n            // eslint-disable-next-line @typescript-eslint/prefer-promise-reject-errors\n            return Promise.reject(err);\n        }\n\n        const sal: IStreamAndLength = {\n            length: buff.length,\n            reset: async () => {\n                return Promise.resolve(sal);\n            },\n            stream: bufferToStream(buff),\n        };\n        return Promise.resolve(sal);\n    }\n\n    private async transformBuffer(publication: Publication, _link: Link, data: Buffer): Promise<Buffer> {\n\n        let pubID = publication.Metadata.Identifier;\n        pubID = pubID.replace(\"urn:uuid:\", \"\");\n        pubID = pubID.replace(/-/g, \"\");\n        pubID = pubID.replace(/\\s/g, \"\");\n\n        const key = [];\n        for (let i = 0; i < 16; i++) {\n            const byteHex = pubID.substr(i * 2, 2);\n            const byteNumer = parseInt(byteHex, 16);\n            key.push(byteNumer);\n        }\n\n        const prefixLength = 1024;\n        const zipDataPrefix = data.slice(0, prefixLength);\n\n        for (let i = 0; i < prefixLength; i++) {\n            /* tslint:disable:no-bitwise */\n            zipDataPrefix[i] = zipDataPrefix[i] ^ (key[i % key.length]);\n        }\n\n        const zipDataRemainder = data.slice(prefixLength);\n        return Promise.resolve(Buffer.concat([zipDataPrefix, zipDataRemainder]));\n    }\n\n    // public async getDecryptedSizeStream(\n    //     publication: Publication, link: Link,\n    //     stream: IStreamAndLength): Promise<number> {\n    //     let sal: IStreamAndLength;\n    //     try {\n    //         sal = await this.transformStream(publication, link, stream, false, 0, 0);\n    //     } catch (err) {\n    //         console.log(err);\n    //         // eslint-disable-next-line @typescript-eslint/prefer-promise-reject-errors\n    //         return Promise.reject(\"WTF?\");\n    //     }\n    //     return Promise.resolve(sal.length);\n    // }\n\n    // public async getDecryptedSizeBuffer(publication: Publication, link: Link, data: Buffer): Promise<number> {\n    //     let buff: Buffer;\n    //     try {\n    //         buff = await this.transformBuffer(publication, link, data);\n    //     } catch (err) {\n    //         console.log(err);\n    //         // eslint-disable-next-line @typescript-eslint/prefer-promise-reject-errors\n    //         return Promise.reject(\"WTF?\");\n    //     }\n    //     return Promise.resolve(buff.length);\n    // }\n}\n"]}