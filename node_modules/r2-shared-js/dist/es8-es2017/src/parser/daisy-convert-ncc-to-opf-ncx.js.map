{"version":3,"file":"daisy-convert-ncc-to-opf-ncx.js","sourceRoot":"","sources":["../../../../src/parser/daisy-convert-ncc-to-opf-ncx.ts"],"names":[],"mappings":"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","sourcesContent":["// ==LICENSE-BEGIN==\n// Copyright 2017 European Digital Reading Lab. All rights reserved.\n// Licensed to the Readium Foundation under one or more contributor license agreements.\n// Use of this source code is governed by a BSD-style license\n// that can be found in the LICENSE file exposed on Github (readium) in the project repository.\n// ==LICENSE-END==\n\nimport * as he from \"he\";\nimport * as debug_ from \"debug\";\nimport * as mime from \"mime-types\";\nimport * as path from \"path\";\nimport * as xmldom from \"@xmldom/xmldom\";\n\nimport { timeStrToSeconds } from \"@models/media-overlay\";\nimport { streamToBufferPromise } from \"@r2-utils-js/_utils/stream/BufferUtils\";\nimport { IStreamAndLength, IZip } from \"@r2-utils-js/_utils/zip/zip\";\nimport { removeUTF8BOM } from \"@r2-utils-js/_utils/bom\";\n\nimport { zipHasEntry } from \"../_utils/zipHasEntry\";\nimport { getNcx_, getOpf_ } from \"./epub-daisy-common\"; // , loadFileStrFromZipPath\nimport { NCX } from \"./epub/ncx\";\nimport { OPF } from \"./epub/opf\";\n\nconst debug = debug_(\"r2:shared#parser/daisy-convert-to-epub\");\n\n// Removal of all encoding layers (two pass) is a reasonable approach for DAISY NCC HTML metadata and hyperlinks\n// (normally just one pass, but often authored with \"forced\" escaped chars despite unicode support on the consumer side)\n\n// Example ncc.html attribute value:\n// <element attribute=\" &nbsp;&quot; &amp;#39; -- &#39; == ' xxx &lt; yyy &gt; zzz &amp;lt; &amp; \" />\n// ...parsed by xmldom (all entities decoded):\n// [  \" &#39; -- ' == ' xxx < yyy > zzz &lt; & ]\n// ...he.decode() second pass:\n// [  \" ' -- ' == ' xxx < yyy > zzz < & ]\n// ...JSON serialise (trimmed):\n// \"property\": \"\\\" ' -- ' == ' xxx < yyy > zzz < &\"\nconst decodeHtmlAttributeValue = (val: string) => {\n    const decoded = he.decode(val, { isAttributeValue: true });\n    // if (val !== decoded) {\n    //     console.log(`====== decodeHtmlAttributeValue [${val}] ==> [${decoded}]`);\n    // }\n    return decoded;\n};\n// Example ncc.html text content:\n// <element> \" &nbsp;&quot; &amp;#39; -- &#39; == ' xxx &lt; yyy &gt; zzz &amp;lt; &amp; </element>\n// ...parsed by xmldom (all entities decoded):\n// [ \"  \" &#39; -- ' == ' xxx < yyy > zzz &lt; & ]\n// ...he.decode() second pass:\n// [ \"  \" ' -- ' == ' xxx < yyy > zzz < & ]\n// ...JSON serialise (trimmed):\n// \"property\": \"\\\"  \\\" ' -- ' == ' xxx < yyy > zzz < &\"\nconst decodeHtmlTextContent = (textContent: string) => {\n    const decoded = he.decode(textContent);\n    // if (textContent !== decoded) {\n    //     console.log(`====== decodeHtmlTextContent [${textContent}] ==> [${decoded}]`);\n    // }\n    return decoded;\n};\n\nconst encodeXmlAttributeValue = (val: string) => {\n    return val.replace(/\"/g, \"&quot;\"); // .replace(/'/g, \"&#39;\"); // &#39; == &apos;\n};\nconst encodeXmlTextContent = (textContent: string) => {\n    return textContent.replace(/&/g, \"&amp;\").replace(/</g, \"&lt;\").replace(/>/g, \"&gt;\");\n};\n\nconst getMediaTypeFromFileExtension = (ext: string) => {\n    if (/\\.smil$/i.test(ext)) {\n        return \"application/smil+xml\";\n    }\n\n    if (/\\.css$/i.test(ext)) {\n        return \"text/css\";\n    }\n\n    if (/\\.mp3$/i.test(ext)) {\n        return \"audio/mpeg\";\n    }\n\n    if (/\\.wav$/i.test(ext)) {\n        return \"audio/wav\";\n    }\n\n    if (/\\.jpe?g$/i.test(ext)) {\n        return \"image/jpeg\";\n    }\n\n    if (/\\.png$/i.test(ext)) {\n        return \"image/png\";\n    }\n\n    if (/\\.xml$/i.test(ext)) {\n        return \"application/x-dtbook+xml\";\n    }\n\n    if (/\\.html$/i.test(ext)) {\n        return \"text/html\";\n    }\n\n    if (/\\.xhtml$/i.test(ext)) {\n        return \"application/xhtml+xml\";\n    }\n\n    return mime.lookup(\"dummy\" + ext);\n};\n\nexport const convertNccToOpfAndNcx = async (\n    zip: IZip,\n    rootfilePathDecoded: string,\n    rootfilePath: string,\n): Promise<[OPF, NCX]> => {\n\n    const has = await zipHasEntry(zip, rootfilePathDecoded, rootfilePath);\n    if (!has) {\n        const err = `NOT IN ZIP (NCC.html): ${rootfilePath} --- ${rootfilePathDecoded}`;\n        debug(err);\n        const zipEntries = await zip.getEntries();\n        for (const zipEntry of zipEntries) {\n            if (zipEntry.startsWith(\"__MACOSX/\")) {\n                continue;\n            }\n            debug(zipEntry);\n        }\n        // eslint-disable-next-line @typescript-eslint/prefer-promise-reject-errors\n        return Promise.reject(err);\n    }\n\n    let nccZipStream_: IStreamAndLength;\n    try {\n        nccZipStream_ = await zip.entryStreamPromise(rootfilePathDecoded);\n    } catch (err) {\n        debug(err);\n        // eslint-disable-next-line @typescript-eslint/prefer-promise-reject-errors\n        return Promise.reject(err);\n    }\n    const nccZipStream = nccZipStream_.stream;\n\n    let nccZipData: Buffer;\n    try {\n        nccZipData = await streamToBufferPromise(nccZipStream);\n    } catch (err) {\n        debug(err);\n        // eslint-disable-next-line @typescript-eslint/prefer-promise-reject-errors\n        return Promise.reject(err);\n    }\n\n    let nccStr = removeUTF8BOM(nccZipData.toString(\"utf8\"));\n\n    // https://github.com/readium/r2-shared-js/commit/a83c8d6b56edb97bc2acc6889347274888feaecb#diff-ac9dbda3443005fb662618cf819db718d98b2361d98a4c39d574a6e5ddc3bda2\n    let nccDoc: Document | undefined;\n    try {\n        nccDoc = new xmldom.DOMParser().parseFromString(\n            nccStr,\n            // \"application/xml\",\n            \"text/html\",\n            // \"application/xhtml+xml\",\n        ) as unknown as Document;\n    } catch (err1) {\n        console.log(\"xmldom.DOMParser().parseFromString text/html ERROR1, attempting DOCTYPE fix...\");\n        console.log(err1);\n        // <!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\" []>\n        // console.log(nccStr.substring(0, 600));\n        nccStr = nccStr.replace(/(<!DOCTYPE\\s+[^>]+\\s*)\\[\\s*\\]\\s*>/, \"$1>\");\n        // console.log(nccStr.substring(0, 600));\n        try {\n            nccDoc = new xmldom.DOMParser().parseFromString(\n                nccStr,\n                // \"application/xml\",\n                \"text/html\",\n                // \"application/xhtml+xml\",\n            ) as unknown as Document;\n        } catch (err2) {\n            console.log(\"xmldom.DOMParser().parseFromString text/html ERROR2, fallback to application/xml...\");\n            console.log(err2);\n            nccDoc = new xmldom.DOMParser().parseFromString(\n                nccStr,\n                \"application/xml\",\n                // \"text/html\",\n                // \"application/xhtml+xml\",\n            ) as unknown as Document;\n        }\n    }\n\n    const metas = Array.from(nccDoc.getElementsByTagName(\"meta\")).\n        reduce((prevVal, curVal) => {\n            const name = curVal.getAttribute(\"name\");\n            const content = curVal.getAttribute(\"content\");\n            if (name && content) {\n                prevVal[name] = decodeHtmlAttributeValue(content.trim());\n            }\n            return prevVal;\n        }, {} as {[key: string]: string});\n\n    const aElems = Array.from(nccDoc.getElementsByTagName(\"a\"));\n\n    // TODO: textPartAudio / audioPartText?? audioOnly??\n    // https://www.daisy.org/z3986/specifications/Z39-86-2002.html#Type\n    // https://www.daisy.org/z3986/specifications/daisy_202.html\n    let multimediaContent = \"\";\n    let multimediaType = \"\";\n    if (metas[\"ncc:multimediaType\"] === \"audioFullText\" ||\n        metas[\"ncc:multimediaType\"] === \"audioNcc\" ||\n        metas[\"ncc:totalTime\"] && timeStrToSeconds(metas[\"ncc:totalTime\"]) > 0) {\n        if (metas[\"ncc:multimediaType\"] === \"audioFullText\" || !metas[\"ncc:multimediaType\"]) {\n            multimediaContent = \"audio,text,image\";\n            multimediaType = \"audioFullText\";\n        } else {\n            multimediaContent = \"audio,image\";\n            multimediaType = \"audioNCX\";\n        }\n    } else if (metas[\"ncc:multimediaType\"] === \"textNcc\" ||\n        metas[\"ncc:totalTime\"] && timeStrToSeconds(metas[\"ncc:totalTime\"]) === 0) {\n        multimediaContent = \"text,image\";\n        multimediaType = \"textNCX\";\n    }\n\n    const zipEntriez = (await zip.getEntries()).filter((e) => {\n        return e && !e.endsWith(\"/\"); // exclude folders!\n    });\n\n    const manifestItemsBaseStr = zipEntriez.reduce((pv, cv, ci) => {\n        const ext = path.extname(cv);\n        return `${pv}${!cv.startsWith(\"__MACOSX/\") && !/ncc\\.html$/i.test(cv) && !/\\.ent$/i.test(ext) && !/\\.dtd$/i.test(ext) && !/\\.smil$/i.test(ext) ? `\n        <item\n            href=\"${encodeXmlAttributeValue(path.relative(\"file:///\" + path.dirname(rootfilePathDecoded), \"file:///\" + cv).replace(/\\\\/g, \"/\"))}\"\n            id=\"opf-zip-${ci}\"\n            media-type=\"${getMediaTypeFromFileExtension(ext)}\" />` : \"\"}`;\n    }, \"\");\n    const arrSmils: string[] = [];\n    const manifestItemsStr = aElems.reduce((pv, cv, _ci) => {\n        const href = cv.getAttribute(\"href\");\n        if (!href) {\n            return pv;\n        }\n        if (!/\\.smil(#.*)?$/i.test(href)) {\n            return pv;\n        }\n\n        const smil = href.replace(/(.+\\.smil)(#.*)?$/i, \"$1\");\n        if (arrSmils.indexOf(smil) >= 0) {\n            return pv;\n        }\n        arrSmils.push(smil);\n\n        // const txt = cv.textContent ? cv.textContent.trim() : \"\";\n\n        return `${pv}${`\n            <item\n                href=\"${encodeXmlAttributeValue(smil)}\"\n                id=\"opf-ncc-${arrSmils.length - 1}\"\n                media-type=\"application/smil+xml\" />`}`;\n    }, manifestItemsBaseStr);\n\n    const spineItemsStr = arrSmils.reduce((pv, _cv, ci) => {\n        return `${pv}${`\n            <itemref idref=\"opf-ncc-${ci}\" />`}`;\n    }, \"\");\n\n    let playOrder = 0;\n    let pCount = 0;\n    const pageListStr = aElems.reduce((pv, cv, _ci) => {\n        const href = cv.getAttribute(\"href\");\n        if (!href) {\n            return pv;\n        }\n        if (!/\\.smil(#.*)?$/i.test(href)) {\n            return pv;\n        }\n        if (!cv.parentNode) {\n            return pv;\n        }\n        playOrder++;\n\n        const clazz = (cv.parentNode as Element).getAttribute(\"class\");\n        if (!clazz || !clazz.startsWith(\"page\")) {\n            return pv;\n        }\n\n        const txtContent = cv.textContent ? decodeHtmlTextContent(cv.textContent.trim()) : \"\";\n\n        pCount++;\n        return `${pv}${`\n<pageTarget class=\"pagenum\" id=\"ncx-p${pCount}\" playOrder=\"${playOrder}\" type=\"normal\" value=\"${pCount}\">\n<navLabel>\n<text>${txtContent ? encodeXmlTextContent(txtContent) : pCount}</text>\n</navLabel>\n<content src=\"${encodeXmlAttributeValue(href)}\"/>\n</pageTarget>\n`}`;\n    }, \"\");\n\n    playOrder = 0;\n    pCount = 0;\n    const navMapStr = aElems.reduce((pv, cv, _ci) => {\n        const href = cv.getAttribute(\"href\");\n        if (!href) {\n            return pv;\n        }\n        if (!/\\.smil(#.*)?$/i.test(href)) {\n            return pv;\n        }\n        if (!cv.parentNode) {\n            return pv;\n        }\n        playOrder++;\n\n        const name = (cv.parentNode as Element).localName;\n        if (!name || !name.startsWith(\"h\")) {\n            return pv;\n        }\n        const level = parseInt(name.substr(1), 10);\n\n        const txtContent = cv.textContent ? decodeHtmlTextContent(cv.textContent.trim()) : \"\";\n\n        pCount++;\n\n        const inner = `<!-- h${level-1}_${pCount-1} -->`;\n        if (pv.indexOf(inner) >= 0) {\n            return pv.replace(inner, `\n<navPoint class=\"${name}\" id=\"ncx-t${pCount}\" playOrder=\"${playOrder}\">\n<navLabel>\n<text>${txtContent ? encodeXmlTextContent(txtContent) : `_${pCount}`}</text>\n</navLabel>\n<content src=\"${encodeXmlAttributeValue(href)}\"/>\n<!-- ${name}_${pCount} -->\n</navPoint>\n<!-- h${level-1}_${pCount} -->\n`);\n        } else {\n            return `${pv}${`\n<navPoint class=\"${name}\" id=\"ncx-t${pCount}\" playOrder=\"${playOrder}\">\n<navLabel>\n<text>${txtContent ? encodeXmlTextContent(txtContent) : `_${pCount}`}</text>\n</navLabel>\n<content src=\"${encodeXmlAttributeValue(href)}\"/>\n<!-- ${name}_${pCount} -->\n</navPoint>\n`}`;\n        }\n    }, \"\");\n\n    const opfStr = `<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<!DOCTYPE package\nPUBLIC \"+//ISBN 0-9673008-1-9//DTD OEB 1.2 Package//EN\"\n\"http://openebook.org/dtds/oeb-1.2/oebpkg12.dtd\">\n<package xmlns=\"http://openebook.org/namespaces/oeb-package/1.0/\" unique-identifier=\"uid\">\n\n<metadata>\n<dc-metadata xmlns:dc=\"http://purl.org/dc/elements/1.1/\"\nxmlns:oebpackage=\"http://openebook.org/namespaces/oeb-package/1.0/\">\n    <dc:Format>ANSI/NISO Z39.86-2005</dc:Format>\n    ${metas[\"dc:date\"] ? `<dc:Date>${encodeXmlTextContent(metas[\"dc:date\"])}</dc:Date>` : \"\"}\n    ${metas[\"dc:language\"] ? `<dc:Language>${encodeXmlTextContent(metas[\"dc:language\"])}</dc:Language>` : \"\"}\n    ${metas[\"dc:creator\"] ? `<dc:Creator>${encodeXmlTextContent(metas[\"dc:creator\"])}</dc:Creator>` : \"\"}\n    ${metas[\"dc:publisher\"] ? `<dc:Publisher>${encodeXmlTextContent(metas[\"dc:publisher\"])}</dc:Publisher>` : \"\"}\n    ${metas[\"dc:title\"] ? `<dc:Title>${encodeXmlTextContent(metas[\"dc:title\"])}</dc:Title>` : \"\"}\n    ${metas[\"dc:identifier\"] ? `<dc:Identifier id=\"uid\">${encodeXmlTextContent(metas[\"dc:identifier\"])}</dc:Identifier>` : \"\"}\n</dc-metadata>\n\n<x-metadata>\n    ${metas[\"ncc:narrator\"] ? `<meta name=\"dtb:narrator\" content=\"${encodeXmlAttributeValue(metas[\"ncc:narrator\"])}\" />` : \"\"}\n    ${metas[\"ncc:totalTime\"] ? `<meta name=\"dtb:totalTime\" content=\"${encodeXmlAttributeValue(metas[\"ncc:totalTime\"])}\" />` : \"\"}\n\n    <meta name=\"dtb:multimediaType\" content=\"${encodeXmlAttributeValue(multimediaType)}\" />\n    <meta name=\"dtb:multimediaContent\" content=\"${encodeXmlAttributeValue(multimediaContent)}\" />\n\n    <!-- RAW COPY FROM DAISY2: -->\n    ${Object.keys(metas).reduce((pv, cv) => {\n        return `${pv}\n    <meta name=\"${cv}\" content=\"${encodeXmlAttributeValue(metas[cv])}\" />`;\n    }, \"\")}\n</x-metadata>\n\n</metadata>\n\n<manifest>\n<!-- item href=\"package.opf\" id=\"opf\" media-type=\"text/xml\" />\n<item href=\"navigation.ncx\" id=\"ncx\" media-type=\"application/x-dtbncx+xml\" / -->\n\n${manifestItemsStr}\n</manifest>\n\n<spine>\n${spineItemsStr}\n</spine>\n\n</package>`;\n\n    // debug(opfStr);\n    // if (process.env) {\n    //     throw new Error(\"BREAK\");\n    // }\n\n    const opf = getOpf_(opfStr, rootfilePathDecoded);\n\n    const ncxStr = `<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<ncx xmlns=\"http://www.daisy.org/z3986/2005/ncx/\" version=\"2005-1\">\n<head>\n    ${metas[\"dc:identifier\"] ? `<meta name=\"dtb:uid\" content=\"${encodeXmlAttributeValue(metas[\"dc:identifier\"])}\" />` : \"\"}\n    ${metas[\"ncc:generator\"] ? `<meta name=\"dtb:generator\" content=\"${encodeXmlAttributeValue(metas[\"ncc:generator\"])}\"/>` : \"\"}\n    ${metas[\"ncc:depth\"] ? `<meta name=\"dtb:depth\" content=\"${encodeXmlAttributeValue(metas[\"ncc:depth\"])}\"/>` : \"\"}\n    ${metas[\"ncc:pageNormal\"] ? `<meta name=\"dtb:totalPageCount\" content=\"${encodeXmlAttributeValue(metas[\"ncc:pageNormal\"])}\"/>` : \"\"}\n    ${metas[\"ncc:maxPageNormal\"] ? `<meta name=\"dtb:maxPageNumber\" content=\"${encodeXmlAttributeValue(metas[\"ncc:maxPageNormal\"])}\"/>` : \"\"}\n</head>\n\n<docTitle>\n<text>${metas[\"dc:title\"] ? encodeXmlTextContent(metas[\"dc:title\"]) : \"_\"}</text>\n</docTitle>\n\n<docAuthor>\n<text>${metas[\"dc:creator\"] ? encodeXmlTextContent(metas[\"dc:creator\"]) : \"-\"}</text>\n</docAuthor>\n\n<navMap id=\"navMap\">\n${navMapStr}\n</navMap>\n\n<pageList id=\"pageList\">\n${pageListStr}\n</pageList>\n\n</ncx>`;\n\n    // debug(ncxStr);\n    // if (process.env) {\n    //     throw new Error(\"BREAK\");\n    // }\n\n    const ncx = getNcx_(ncxStr, rootfilePathDecoded);\n\n    return [opf, ncx];\n};\n"]}