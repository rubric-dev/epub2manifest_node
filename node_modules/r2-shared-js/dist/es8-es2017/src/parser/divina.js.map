{"version":3,"file":"divina.js","sourceRoot":"","sources":["../../../../src/parser/divina.ts"],"names":[],"mappings":"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","sourcesContent":["// ==LICENSE-BEGIN==\n// Copyright 2017 European Digital Reading Lab. All rights reserved.\n// Licensed to the Readium Foundation under one or more contributor license agreements.\n// Use of this source code is governed by a BSD-style license\n// that can be found in the LICENSE file exposed on Github (readium) in the project repository.\n// ==LICENSE-END==\n\nimport * as debug_ from \"debug\";\nimport * as fs from \"fs\";\nimport * as http from \"http\";\nimport * as https from \"https\";\nimport * as path from \"path\";\n\nimport { Publication } from \"@models/publication\";\nimport { LCP } from \"@r2-lcp-js/parser/epub/lcp\";\nimport { TaJsonDeserialize } from \"@r2-lcp-js/serializable\";\nimport { isHTTP } from \"@r2-utils-js/_utils/http/UrlUtils\";\nimport { traverseJsonObjects } from \"@r2-utils-js/_utils/JsonUtils\";\nimport { streamToBufferPromise } from \"@r2-utils-js/_utils/stream/BufferUtils\";\nimport { IStreamAndLength, IZip } from \"@r2-utils-js/_utils/zip/zip\";\nimport { zipLoadPromise } from \"@r2-utils-js/_utils/zip/zipFactory\";\n\nimport { zipHasEntry } from \"../_utils/zipHasEntry\";\n\nconst debug = debug_(\"r2:shared#parser/divina\");\n\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nfunction absolutizeURLs(rootUrl: string, jsonObj: any) {\n    traverseJsonObjects(jsonObj,\n        (obj) => {\n            if (obj.href && typeof obj.href === \"string\"\n                && !isHTTP(obj.href)) {\n                // obj.href_ = obj.href;\n                obj.href = rootUrl + \"/\" + obj.href;\n            }\n        });\n}\n\n// tslint:disable-next-line:max-line-length\nexport async function DivinaParsePromise(filePath: string, isDivina?: Divinais, pubtype?: string): Promise<Publication> {\n\n    const isAnDivina = isDivina || await isDivinaPublication(filePath);\n\n    const publicationType = pubtype || (isAnDivina ? \"divina\" : \"generic\");\n\n    // // excludes Divinais.RemoteExploded\n    // const canLoad = isAnDivina === Divinais.LocalExploded ||\n    //     isAnDivina === Divinais.LocalPacked ||\n    //     isAnDivina === Divinais.RemotePacked;\n    // if (!canLoad) {\n    //     // TODO? r2-utils-js zip-ext.ts => variant for HTTP without directory listing? (no deterministic zip entries)\n    //     const err = \"Cannot load exploded remote EPUB (needs filesystem access to list directory contents).\";\n    //     debug(err);\n    //     // eslint-disable-next-line @typescript-eslint/prefer-promise-reject-errors\n    //     return Promise.reject(err);\n    // }\n\n    let entryName = \"manifest.json\";\n\n    let filePathToLoad = filePath;\n    if (isAnDivina === Divinais.LocalExploded) { // (must ensure is directory/folder)\n        filePathToLoad = path.dirname(filePathToLoad) + \"/\";\n    } else if (isAnDivina === Divinais.RemoteExploded) {\n        const url = new URL(filePathToLoad);\n        entryName = path.basename(url.pathname);\n        url.pathname = path.dirname(url.pathname) + \"/\";\n\n        // contains trailing slash\n        filePathToLoad = url.toString();\n    }\n\n    let zip: IZip;\n    try {\n        zip = await zipLoadPromise(filePathToLoad);\n    } catch (err) {\n        // eslint-disable-next-line @typescript-eslint/prefer-promise-reject-errors\n        return Promise.reject(err);\n    }\n\n    if (!zip.hasEntries()) {\n        // eslint-disable-next-line @typescript-eslint/prefer-promise-reject-errors\n        return Promise.reject(\"Divina zip empty\");\n    }\n    if (isAnDivina === Divinais.LocalExploded ||\n        isAnDivina === Divinais.LocalPacked) {\n\n        const has = await zipHasEntry(zip, entryName, undefined);\n        if (!has) {\n            const zipEntries = await zip.getEntries();\n            for (const zipEntry of zipEntries) {\n                if (zipEntry.startsWith(\"__MACOSX/\")) {\n                    continue;\n                }\n                debug(zipEntry);\n            }\n            // eslint-disable-next-line @typescript-eslint/prefer-promise-reject-errors\n            return Promise.reject(\"Divina no manifest?!\");\n        }\n    }\n\n    // let entries: string[];\n    // try {\n    //     entries = await zip.getEntries();\n    // } catch (err) {\n    //     console.log(err);\n    //     // eslint-disable-next-line @typescript-eslint/prefer-promise-reject-errors\n    //     return Promise.reject(\"Problem getting Divina zip entries\");\n    // }\n    // for (const entryName of entries) {\n    //     // debug(\"++ZIP: entry\");\n    //     // debug(entryName);\n\n    //     if (entryName === \"manifest.json\") {\n    //         // import { tryDecodeURI } from \"../_utils/decodeURI\";\n    //         // const entryNameDecoded = tryDecodeURI(entryName);\n    //         // if (!entryNameDecoded) {\n    //         //     return Promise.reject(`Cannot decode URI?! ${entryName}`);\n    //         // }\n    //     }\n    // }\n\n    let manifestZipStream_: IStreamAndLength;\n    try {\n        manifestZipStream_ = await zip.entryStreamPromise(entryName);\n    } catch (err) {\n        debug(err);\n        // eslint-disable-next-line @typescript-eslint/prefer-promise-reject-errors\n        return Promise.reject(`Problem streaming Divina zip entry?! ${entryName}`);\n    }\n    const manifestZipStream = manifestZipStream_.stream;\n    let manifestZipData: Buffer;\n    try {\n        manifestZipData = await streamToBufferPromise(manifestZipStream);\n    } catch (err) {\n        debug(err);\n        // eslint-disable-next-line @typescript-eslint/prefer-promise-reject-errors\n        return Promise.reject(`Problem buffering Divina zip entry?! ${entryName}`);\n    }\n\n    const manifestJsonStr = manifestZipData.toString(\"utf8\");\n    const manifestJson = JSON.parse(manifestJsonStr);\n\n    if (isAnDivina === Divinais.RemoteExploded) {\n        const url = new URL(filePath);\n        url.pathname = path.dirname(url.pathname);\n        absolutizeURLs(url.toString(), manifestJson);\n    }\n\n    const publication = TaJsonDeserialize<Publication>(manifestJson, Publication);\n\n    publication.AddToInternal(\"type\", publicationType);\n    publication.AddToInternal(\"zip\", zip);\n\n    const lcpEntryName = \"license.lcpl\";\n    let checkLCP = true; // allows isAnDivina === Divinais.RemoteExploded\n    let hasLCP = false; // only if zipHasEntry() verifies presence of lcpEntryName (Divinais.LocalExploded|Packed)\n    if (isAnDivina === Divinais.LocalExploded ||\n        isAnDivina === Divinais.LocalPacked) {\n        const has = await zipHasEntry(zip, lcpEntryName, undefined);\n        if (!has) {\n            checkLCP = false;\n        } else {\n            hasLCP = true;\n        }\n    }\n    if (checkLCP) {\n        let lcpZipStream_: IStreamAndLength | undefined;\n        try {\n            lcpZipStream_ = await zip.entryStreamPromise(lcpEntryName);\n        } catch (err) {\n            if (hasLCP) {\n                debug(err);\n                // eslint-disable-next-line @typescript-eslint/prefer-promise-reject-errors\n                return Promise.reject(`Problem streaming Divina LCP zip entry?! ${entryName}`);\n            } else {\n                debug(\"Divina no LCP.\");\n            }\n            checkLCP = false;\n        }\n        if (checkLCP && lcpZipStream_) {\n            const lcpZipStream = lcpZipStream_.stream;\n            let lcpZipData: Buffer;\n            try {\n                lcpZipData = await streamToBufferPromise(lcpZipStream);\n            } catch (err) {\n                debug(err);\n                // eslint-disable-next-line @typescript-eslint/prefer-promise-reject-errors\n                return Promise.reject(`Problem buffering Divina LCP zip entry?! ${entryName}`);\n            }\n\n            const lcpJsonStr = lcpZipData.toString(\"utf8\");\n            const lcpJson = JSON.parse(lcpJsonStr);\n\n            const lcpl = TaJsonDeserialize<LCP>(lcpJson, LCP);\n            lcpl.ZipPath = lcpEntryName;\n            lcpl.JsonSource = lcpJsonStr;\n            lcpl.init();\n\n            publication.LCP = lcpl;\n        }\n    }\n\n    return Promise.resolve(publication);\n}\n\n// https://github.com/readium/divina-player-js/blob/master/public/webtoon/manifest.json\n// curl -s -L -I -X GET xxx\n// Content-Type: application/divina+json; charset=utf-8\nexport enum Divinais {\n    LocalExploded = \"LocalExploded\",\n    LocalPacked = \"LocalPacked\",\n    RemoteExploded = \"RemoteExploded\",\n    RemotePacked = \"RemotePacked\",\n}\n\nasync function doRequest(u: string): Promise<Divinais | undefined> {\n    return new Promise<Divinais | undefined>((resolve, _reject) => {\n        const url = new URL(u);\n        const secure = url.protocol === \"https:\";\n        const options = {\n            headers: {\n                \"Accept\": \"*/*,application/divina+json\",\n                \"Accept-Language\": \"en-UK,en-US;q=0.7,en;q=0.5\",\n                \"Host\": url.host,\n                \"User-Agent\": \"Readium2-Divinas\",\n            },\n            host: url.host,\n            method: \"GET\",\n            path: url.pathname + url.search,\n            port: secure ? 443 : 80,\n            protocol: url.protocol,\n        };\n        debug(JSON.stringify(options));\n        (secure ? https : http).request(options, (res) => {\n            if (!res) {\n                resolve(undefined);\n                // reject(`HTTP no response ${u}`);\n                return;\n            }\n\n            debug(res.statusCode);\n            debug(JSON.stringify(res.headers));\n\n            if (res.statusCode && (res.statusCode >= 300 && res.statusCode < 400)) {\n                const loc = res.headers.Location || res.headers.location;\n                if (loc && loc.length) {\n                    const l = Array.isArray(loc) ? loc[0] : loc;\n                    process.nextTick(async () => {\n                        try {\n                            const redirectRes = await doRequest(l);\n                            resolve(redirectRes);\n                        } catch (_err) {\n                            resolve(undefined);\n                            // reject(`HTTP Divina redirect, then fail ${u} ${err}`);\n                        }\n                    });\n                } else {\n                    resolve(undefined);\n                    // reject(`HTTP Divina redirect without location?! ${u}`);\n                }\n                return;\n            }\n            const type = res.headers[\"Content-Type\"] || res.headers[\"content-type\"];\n            if (type) {\n                if (type.includes(\"application/divina+json\")) {\n                    resolve(Divinais.RemoteExploded);\n                    return;\n                }\n                if (type.includes(\"application/json\")) {\n                    res.setEncoding(\"utf8\");\n\n                    let responseBody = \"\";\n                    res.on(\"data\", (chunk) => {\n                        responseBody += chunk;\n                    });\n                    res.on(\"end\", () => {\n                        try {\n                            const manJson = JSON.parse(responseBody);\n                            if (manJson.metadata && manJson.metadata[\"@type\"] &&\n                                (/https?:\\/\\/schema\\.org\\/VisualArtwork$/.test(manJson.metadata[\"@type\"]) ||\n                                /https?:\\/\\/schema\\.org\\/ComicStory$/.test(manJson.metadata[\"@type\"]))\n                            ) {\n                                resolve(Divinais.RemoteExploded);\n                                return;\n                            } else {\n                                resolve(undefined);\n                                // reject(`HTTP JSON not Divina ${u}`);\n                            }\n                        } catch (ex) {\n                            debug(ex);\n                            resolve(undefined);\n                            // reject(`HTTP Divina invalid JSON?! ${u} ${ex}`);\n                        }\n                    });\n\n                    return;\n                }\n            }\n            resolve(undefined);\n            // reject(`Not HTTP Divina type ${u}`);\n        }).on(\"error\", (err) => {\n            debug(err);\n            resolve(undefined);\n            // reject(`HTTP error ${u} ${err}`);\n        }).end();\n    });\n}\n\nexport async function isDivinaPublication(urlOrPath: string): Promise<Divinais | undefined> {\n    let p = urlOrPath;\n    const isHttp = isHTTP(urlOrPath);\n    if (isHttp) {\n        const url = new URL(urlOrPath);\n        p = url.pathname;\n    }\n\n    const fileName = path.basename(p);\n    const ext = path.extname(fileName);\n\n    const dnva = /\\.divina$/i.test(ext);\n    const dnvaLcp = /\\.lcpdivina$/i.test(ext);\n    if (dnva || dnvaLcp) {\n        // return isHttp ? Divinais.RemotePacked : Divinais.LocalPacked;\n        if (!isHttp) {\n            return Divinais.LocalPacked;\n        }\n    }\n\n    if (!isHttp && fileName === \"manifest.json\") {\n        // const manPath = fileName === \"manifest.json\" ? p : path.join(p, \"manifest.json\");\n        if (fs.existsSync(p)) {\n            const manStr = fs.readFileSync(p, { encoding: \"utf8\" });\n            const manJson = JSON.parse(manStr);\n            if (manJson.metadata && manJson.metadata[\"@type\"] &&\n                (/https?:\\/\\/schema\\.org\\/VisualArtwork$/.test(manJson.metadata[\"@type\"]) ||\n                /https?:\\/\\/schema\\.org\\/ComicStory$/.test(manJson.metadata[\"@type\"]))\n            ) {\n                return Divinais.LocalExploded;\n            }\n        }\n    }\n\n    // // filePath.replace(/\\//, \"/\").endsWith(\"divina/manifest.json\")\n    // if (/divina[\\/|\\\\]manifest.json$/.test(p)) {\n    //     return isHttp ? Divinais.RemoteExploded : Divinais.LocalExploded;\n    // }\n\n    if (isHttp) {\n        return doRequest(urlOrPath);\n    }\n\n    return Promise.resolve(undefined);\n    // // eslint-disable-next-line @typescript-eslint/prefer-promise-reject-errors\n    // return Promise.reject(\"Cannot determine Divina type\");\n}\n"]}