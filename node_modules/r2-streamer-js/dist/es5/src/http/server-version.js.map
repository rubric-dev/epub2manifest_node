{"version":3,"file":"server-version.js","sourceRoot":"","sources":["../../../../src/http/server-version.ts"],"names":[],"mappings":";;;AAOA,+BAAiC;AACjC,mCAAqC;AACrC,8BAAgC;AAEhC,uBAAyB;AACzB,wCAA0C;AAC1C,2BAA6B;AAE7B,6CAEuB;AAGvB,IAAM,KAAK,GAAG,MAAM,CAAC,iCAAiC,CAAC,CAAC;AAGxD,IAAM,SAAS,GAAG,0VAsBjB,CAAC;AAGW,QAAA,kBAAkB,GAAG,UAAU,CAAC;AAC7C,SAAgB,aAAa,CAAC,MAAc,EAAE,SAA8B;IAExE,SAAS,CAAC,GAAG,CAAC,CAAC,0BAAkB,EAAE,0BAAkB,GAAG,GAAG,GAAG,mBAAK,GAAG,IAAI,GAAG,uBAAS,GAAG,GAAG,CAAC,EAC7F,UAAC,GAAoB,EAAE,GAAqB;QAExC,IAAM,SAAS,GAAI,GAAgC,CAAC,MAAM,CAAC;QAE3D,IAAM,MAAM,GAAG,GAAG,CAAC,GAAG,CAAC,OAAO,CAAC,OAAO,CAAC,IAAI,CAAC,IAAK,GAAG,CAAC,KAA6B,CAAC,IAAI,CAAC;QACxF,IAAI,CAAC,SAAS,CAAC,QAAQ,IAAK,GAAG,CAAC,KAA6B,CAAC,IAAI,EAAE;YAChE,SAAS,CAAC,QAAQ,GAAI,GAAG,CAAC,KAA6B,CAAC,IAAI,CAAC;SAChE;QAED,IAAM,UAAU,GAAG,sBAAsB,CAAC;QAC1C,IAAI,CAAC,EAAE,CAAC,UAAU,CAAC,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,IAAI,CAAC,SAAS,EAAE,UAAU,CAAC,CAAC,CAAC,EAAE;YAEhE,IAAM,GAAG,GAAG,wBAAwB,CAAC;YACrC,KAAK,CAAC,GAAG,GAAG,UAAU,CAAC,CAAC;YACxB,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,6CAA6C;kBAC5D,GAAG,GAAG,oBAAoB,CAAC,CAAC;YAClC,OAAO;SACV;QAED,IAAM,OAAO,GAAG,OAAO,CAAC,UAAU,CAAC,CAAC;QAGpC,IAAI,MAAM,EAAE;YACR,IAAM,UAAU,GAAG,UAAU,CAAC,OAAO,EAAE,QAAQ,CAAC,SAAS,CAAC,CAAC,CAAC;YAE5D,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,cAAc;gBAC/B,sCAAsC;gBACtC,cAAc,GAAG,UAAU,GAAG,YAAY;gBAG1C,gBAAgB,CAAC,CAAC;SACzB;aAAM;YACH,MAAM,CAAC,eAAe,CAAC,GAAG,CAAC,CAAC;YAC5B,GAAG,CAAC,GAAG,CAAC,cAAc,EAAE,iCAAiC,CAAC,CAAC;YAE3D,IAAM,OAAO,GAAG,IAAI,CAAC,SAAS,CAAC,OAAO,EAAE,IAAI,EAAE,IAAI,CAAC,CAAC;YAEpD,IAAM,QAAQ,GAAG,MAAM,CAAC,UAAU,CAAC,QAAQ,CAAC,CAAC;YAC7C,QAAQ,CAAC,MAAM,CAAC,OAAO,CAAC,CAAC;YACzB,IAAM,IAAI,GAAG,QAAQ,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;YAEpC,IAAM,KAAK,GAAG,GAAG,CAAC,MAAM,CAAC,eAAe,CAAC,CAAC;YAC1C,IAAI,KAAK,KAAK,IAAI,EAAE;gBAChB,KAAK,CAAC,yBAAyB,CAAC,CAAC;gBACjC,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC;gBAChB,GAAG,CAAC,GAAG,EAAE,CAAC;gBACV,OAAO;aACV;YAED,GAAG,CAAC,SAAS,CAAC,MAAM,EAAE,IAAI,CAAC,CAAC;YAG5B,GAAG,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;SACjC;IACL,CAAC,CAAC,CAAC;AACP,CAAC;AA1DD,sCA0DC","sourcesContent":["// ==LICENSE-BEGIN==\n// Copyright 2017 European Digital Reading Lab. All rights reserved.\n// Licensed to the Readium Foundation under one or more contributor license agreements.\n// Use of this source code is governed by a BSD-style license\n// that can be found in the LICENSE file exposed on Github (readium) in the project repository.\n// ==LICENSE-END==\n\nimport * as crypto from \"crypto\";\nimport * as css2json from \"css2json\";\nimport * as debug_ from \"debug\";\nimport * as express from \"express\";\nimport * as fs from \"fs\";\nimport * as jsonMarkup from \"json-markup\";\nimport * as path from \"path\";\n\nimport {\n    IRequestPayloadExtension, IRequestQueryParams, _jsonPath, _show, _urlEncoded,\n} from \"./request-ext\";\nimport { Server } from \"./server\";\n\nconst debug = debug_(\"r2:streamer#http/server-version\");\n\n// https://github.com/mafintosh/json-markup/blob/master/style.css\nconst jsonStyle = `\n.json-markup {\n    line-height: 17px;\n    font-size: 13px;\n    font-family: monospace;\n    white-space: pre;\n}\n.json-markup-key {\n    font-weight: bold;\n}\n.json-markup-bool {\n    color: firebrick;\n}\n.json-markup-string {\n    color: green;\n}\n.json-markup-null {\n    color: gray;\n}\n.json-markup-number {\n    color: blue;\n}\n`;\n\n// tslint:disable-next-line:variable-name\nexport const serverVersion_PATH = \"/version\";\nexport function serverVersion(server: Server, topRouter: express.Application) {\n\n    topRouter.get([serverVersion_PATH, serverVersion_PATH + \"/\" + _show + \"/:\" + _jsonPath + \"?\"],\n    (req: express.Request, res: express.Response) => {\n\n        const reqparams = (req as IRequestPayloadExtension).params;\n\n        const isShow = req.url.indexOf(\"/show\") >= 0 || (req.query as IRequestQueryParams).show;\n        if (!reqparams.jsonPath && (req.query as IRequestQueryParams).show) {\n            reqparams.jsonPath = (req.query as IRequestQueryParams).show;\n        }\n\n        const gitRevJson = \"../../../gitrev.json\";\n        if (!fs.existsSync(path.resolve(path.join(__dirname, gitRevJson)))) {\n\n            const err = \"Missing Git rev JSON! \";\n            debug(err + gitRevJson);\n            res.status(500).send(\"<html><body><p>Internal Server Error</p><p>\"\n                + err + \"</p></body></html>\");\n            return;\n        }\n\n        const jsonObj = require(gitRevJson);\n        // debug(jsonObj);\n\n        if (isShow) {\n            const jsonPretty = jsonMarkup(jsonObj, css2json(jsonStyle));\n\n            res.status(200).send(\"<html><body>\" +\n                \"<h1>R2-STREAMER-JS VERSION INFO</h1>\" +\n                \"<hr><p><pre>\" + jsonPretty + \"</pre></p>\" +\n                // \"<hr><p><pre>\" + jsonStr + \"</pre></p>\" +\n                // \"<p><pre>\" + dumpStr + \"</pre></p>\" +\n                \"</body></html>\");\n        } else {\n            server.setResponseCORS(res);\n            res.set(\"Content-Type\", \"application/json; charset=utf-8\");\n\n            const jsonStr = JSON.stringify(jsonObj, null, \"  \");\n\n            const checkSum = crypto.createHash(\"sha256\");\n            checkSum.update(jsonStr);\n            const hash = checkSum.digest(\"hex\");\n\n            const match = req.header(\"If-None-Match\");\n            if (match === hash) {\n                debug(\"publications.json cache\");\n                res.status(304); // StatusNotModified\n                res.end();\n                return;\n            }\n\n            res.setHeader(\"ETag\", hash);\n            // server.setResponseCacheHeaders(res, true);\n\n            res.status(200).send(jsonStr);\n        }\n    });\n}\n"]}