{"version":3,"file":"server-opds-browse-v2.js","sourceRoot":"","sources":["../../../../src/http/server-opds-browse-v2.ts"],"names":[],"mappings":"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","sourcesContent":["// ==LICENSE-BEGIN==\n// Copyright 2017 European Digital Reading Lab. All rights reserved.\n// Licensed to the Readium Foundation under one or more contributor license agreements.\n// Use of this source code is governed by a BSD-style license\n// that can be found in the LICENSE file exposed on Github (readium) in the project repository.\n// ==LICENSE-END==\n\nimport * as crypto from \"crypto\";\nimport * as css2json from \"css2json\";\nimport * as debug_ from \"debug\";\nimport * as DotProp from \"dot-prop\";\nimport * as express from \"express\";\nimport * as jsonMarkup from \"json-markup\";\nimport * as morgan from \"morgan\";\nimport * as path from \"path\";\nimport * as request from \"request\";\nimport * as requestPromise from \"request-promise-native\";\nimport { v4 as uuidv4 } from \"uuid\";\n\nimport { TaJsonDeserialize, TaJsonSerialize } from \"@r2-lcp-js/serializable\";\nimport { OPDSFeed } from \"@r2-opds-js/opds/opds2/opds2\";\nimport { OPDSAuthenticationDoc } from \"@r2-opds-js/opds/opds2/opds2-authentication-doc\";\nimport { OPDSPublication } from \"@r2-opds-js/opds/opds2/opds2-publication\";\nimport {\n    encodeURIComponent_RFC3986, ensureAbsolute, isHTTP,\n} from \"@r2-utils-js/_utils/http/UrlUtils\";\nimport { traverseJsonObjects } from \"@r2-utils-js/_utils/JsonUtils\";\nimport { streamToBufferPromise } from \"@r2-utils-js/_utils/stream/BufferUtils\";\n\nimport { jsonSchemaValidate } from \"../utils/json-schema-validate\";\nimport {\n    IRequestPayloadExtension, IRequestQueryParams, _authRefresh, _authRequest, _authResponse,\n    _urlEncoded,\n} from \"./request-ext\";\nimport { Server } from \"./server\";\nimport { serverLCPLSD_show_PATH } from \"./server-lcp-lsd-show\";\nimport { serverOPDS_convert_v1_to_v2_PATH } from \"./server-opds-convert-v1-to-v2\";\nimport { trailingSlashRedirect } from \"./server-trailing-slash-redirect\";\n\nconst debug = debug_(\"r2:streamer#http/server-opds-browse-v2\");\n\n// tslint:disable-next-line:variable-name\nexport const serverOPDS_browse_v2_PATH = \"/opds-v2-browse\";\n\n// tslint:disable-next-line:variable-name\nexport const serverOPDS_dataUrl_PATH = \"/data-url\";\n\n// tslint:disable-next-line:variable-name\nexport const serverOPDS_auth_PATH = \"/opds-auth\";\n\nconst salt = crypto.randomBytes(16).toString(\"hex\");\nconst OPDS_AUTH_ENCRYPTION_KEY_BUFFER = crypto.pbkdf2Sync(uuidv4(), salt, 1000, 32, \"sha256\");\nconst OPDS_AUTH_ENCRYPTION_KEY_HEX = OPDS_AUTH_ENCRYPTION_KEY_BUFFER.toString(\"hex\");\n\nconst AES_BLOCK_SIZE = 16;\nconst OPDS_AUTH_ENCRYPTION_IV_BUFFER = Buffer.from(uuidv4()).slice(0, AES_BLOCK_SIZE);\nconst OPDS_AUTH_ENCRYPTION_IV_HEX = OPDS_AUTH_ENCRYPTION_IV_BUFFER.toString(\"hex\");\n\nexport function serverOPDS_browse_v2(_server: Server, topRouter: express.Application) {\n\n    // https://github.com/mafintosh/json-markup/blob/master/style.css\n    const jsonStyle = `\n.json-markup {\n    line-height: 17px;\n    font-size: 13px;\n    font-family: monospace;\n    white-space: pre;\n}\n.json-markup-key {\n    font-weight: bold;\n}\n.json-markup-bool {\n    color: firebrick;\n}\n.json-markup-string {\n    color: green;\n}\n.json-markup-null {\n    color: gray;\n}\n.json-markup-number {\n    color: blue;\n}\n`;\n\n    // tslint:disable-next-line:variable-name\n    const routerOPDS_browse_v2 = express.Router({ strict: false });\n    routerOPDS_browse_v2.use(morgan(\"combined\", { stream: { write: (msg: any) => debug(msg) } }));\n\n    routerOPDS_browse_v2.use(trailingSlashRedirect);\n\n    routerOPDS_browse_v2.get(\"/\", (_req: express.Request, res: express.Response) => {\n\n        let html = \"<html><head>\";\n        html += `<script type=\"text/javascript\">function encodeURIComponent_RFC3986(str) { ` +\n            `return encodeURIComponent(str).replace(/[!'()*]/g, (c) => { ` +\n            `return \"%\" + c.charCodeAt(0).toString(16); }); }` +\n            `function go(evt) {` +\n            `if (evt) { evt.preventDefault(); } var url = ` +\n            `location.origin +` +\n            // `location.protocol + '//' + location.hostname + ` +\n            // `(location.port ? (':' + location.port) : '') + ` +\n            ` '${serverOPDS_browse_v2_PATH}/' +` +\n            ` encodeURIComponent_RFC3986(document.getElementById(\"url\").value);` +\n            `location.href = url;}</script>`;\n        html += \"</head>\";\n\n        html += \"<body><h1>OPDS feed browser</h1>\";\n\n        html += `<form onsubmit=\"go();return false;\">` +\n            `<input type=\"text\" name=\"url\" id=\"url\" size=\"80\">` +\n            `<input type=\"submit\" value=\"Go!\"></form>`;\n\n        html += \"</body></html>\";\n\n        res.status(200).send(html);\n    });\n\n    routerOPDS_browse_v2.param(\"urlEncoded\", (req, _res, next, value, _name) => {\n        (req as IRequestPayloadExtension).urlEncoded = value;\n        next();\n    });\n\n    routerOPDS_browse_v2.get(\"/:\" + _urlEncoded + \"(*)\", async (req: express.Request, res: express.Response) => {\n\n        const reqparams = (req as IRequestPayloadExtension).params;\n\n        if (!reqparams.urlEncoded) {\n            reqparams.urlEncoded = (req as IRequestPayloadExtension).urlEncoded;\n        }\n\n        let authResponseJson: any | undefined;\n        const authResponseBase64 = (req.query as IRequestQueryParams).authResponse;\n        if (authResponseBase64) {\n            try {\n                const authResponseStr = Buffer.from(authResponseBase64, \"base64\").toString(\"utf8\");\n                authResponseJson = JSON.parse(authResponseStr);\n            } catch (err) {\n                debug(err);\n            }\n        }\n        const authRequestBase64 = (req.query as IRequestQueryParams).authRequest;\n\n        const urlDecoded = reqparams.urlEncoded;\n        // if (urlDecoded.substr(-1) === \"/\") {\n        //     urlDecoded = urlDecoded.substr(0, urlDecoded.length - 1);\n        // }\n        debug(urlDecoded);\n\n        const isSecureHttp = req.secure ||\n            req.protocol === \"https\" ||\n            req.get(\"X-Forwarded-Proto\") === \"https\"\n            ;\n        const rootUrl = (isSecureHttp ? \"https://\" : \"http://\")\n            + req.headers.host;\n\n        const failure = (err: any) => {\n            debug(err);\n            res.status(500).send(\"<html><body><p>Internal Server Error</p><p>\"\n                + err + \"</p></body></html>\");\n        };\n\n        const success = async (response: request.RequestResponse) => {\n\n            // Object.keys(response.headers).forEach((header: string) => {\n            //     debug(header + \" => \" + response.headers[header]);\n            // });\n\n            const isAuthStatusCode = response.statusCode === 401;\n\n            if (isAuthStatusCode && // comment this to test refresh_token\n                authRequestBase64 && authResponseJson && authResponseJson.refresh_token) {\n\n                const redirectUrl = rootUrl + req.originalUrl.substr(0,\n                    req.originalUrl.indexOf(serverOPDS_browse_v2_PATH + \"/\")) +\n                    serverOPDS_auth_PATH + \"/\" + encodeURIComponent_RFC3986(authRequestBase64) +\n                    \"?\" + _authRefresh + \"=\" + authResponseJson.refresh_token;\n\n                debug(`REDIRECT: ${req.originalUrl} ==> ${redirectUrl}`);\n                res.redirect(301, redirectUrl);\n                return;\n            }\n\n            const isBadStatusCode = response.statusCode && (response.statusCode < 200 || response.statusCode >= 300);\n            if (!isAuthStatusCode && isBadStatusCode) {\n                failure(\"HTTP CODE \" + response.statusCode);\n                return;\n            }\n\n            let responseData: Buffer;\n            try {\n                responseData = await streamToBufferPromise(response);\n            } catch (err) {\n                debug(err);\n                res.status(500).send(\"<html><body><p>Internal Server Error</p><p>\"\n                    + err + (isAuthStatusCode ? \" (Auth 401)\" : \"\") + \"</p></body></html>\");\n                return;\n            }\n            const responseStr = responseData.toString(\"utf8\");\n            const responseJson = JSON.parse(responseStr);\n\n            const isPublication = !responseJson.publications &&\n                !responseJson.navigation &&\n                !responseJson.groups &&\n                !responseJson.catalogs &&\n                responseJson.metadata;\n            const isAuth = !isPublication && responseJson.authentication;\n\n            const opds2Feed: OPDSPublication | OPDSFeed | OPDSAuthenticationDoc =\n                // tslint:disable-next-line: max-line-length\n                isPublication ? TaJsonDeserialize<OPDSPublication>(responseJson, OPDSPublication) : // \"application/opds-publication+json\"\n                // tslint:disable-next-line: max-line-length\n                (isAuth ? TaJsonDeserialize<OPDSAuthenticationDoc>(responseJson, OPDSAuthenticationDoc) : // \"application/vnd.opds.authentication.v1.0+json\"\n                TaJsonDeserialize<OPDSFeed>(responseJson, OPDSFeed)); // \"application/opds+json\"\n\n            const opds2FeedJson = TaJsonSerialize(opds2Feed);\n\n            let validationStr: string | undefined;\n            const doValidate = !reqparams.jsonPath || reqparams.jsonPath === \"all\";\n            if (doValidate) {\n\n                const jsonSchemasRootpath = path.join(process.cwd(), \"misc\", \"json-schema\");\n                const jsonSchemasNames = [\n                    \"opds/publication\",\n                    \"opds/acquisition-object\",\n                    \"opds/catalog-entry\",\n                    \"opds/feed-metadata\",\n                    \"opds/properties\",\n                    \"webpub-manifest/publication\",\n                    \"webpub-manifest/contributor-object\",\n                    \"webpub-manifest/contributor\",\n                    \"webpub-manifest/link\",\n                    \"webpub-manifest/metadata\",\n                    \"webpub-manifest/subcollection\",\n                    \"webpub-manifest/properties\",\n                    \"webpub-manifest/subject\",\n                    \"webpub-manifest/subject-object\",\n                    \"webpub-manifest/extensions/epub/metadata\",\n                    \"webpub-manifest/extensions/epub/subcollections\",\n                    \"webpub-manifest/extensions/epub/properties\",\n                    \"webpub-manifest/extensions/presentation/metadata\",\n                    \"webpub-manifest/extensions/presentation/properties\",\n                    \"webpub-manifest/language-map\",\n                ];\n                if (isAuth) {\n                    jsonSchemasNames.unshift(\"opds/authentication\"); // must be first!\n                } else if (!isPublication) {\n                    jsonSchemasNames.unshift(\"opds/feed\"); // must be first!\n                }\n                // debug(jsonSchemasNames);\n\n                const validationErrors =\n                    jsonSchemaValidate(jsonSchemasRootpath, jsonSchemasNames, opds2FeedJson);\n                if (validationErrors) {\n                    validationStr = \"\";\n\n                    for (const err of validationErrors) {\n\n                        debug(\"JSON Schema validation FAIL.\");\n                        debug(err);\n\n                        if (isPublication) {\n                            const val = err.jsonPath ? DotProp.get(opds2FeedJson, err.jsonPath) : \"\";\n                            const valueStr = (typeof val === \"string\") ?\n                                `${val}` :\n                                ((val instanceof Array || typeof val === \"object\") ?\n                                `${JSON.stringify(val)}` :\n                                    \"\");\n                            debug(valueStr);\n\n                            const title = DotProp.get(opds2FeedJson, \"metadata.title\");\n                            debug(title);\n\n                            validationStr +=\n                            // tslint:disable-next-line:max-line-length\n                            `\\n\"${title}\"\\n\\n${err.ajvMessage}: ${valueStr}\\n\\n'${err.ajvDataPath?.replace(/^\\./, \"\")}' (${err.ajvSchemaPath})\\n\\n`;\n                        } else {\n                            const val = err.jsonPath ? DotProp.get(opds2FeedJson, err.jsonPath) : \"\";\n                            const valueStr = (typeof val === \"string\") ?\n                                `${val}` :\n                                ((val instanceof Array || typeof val === \"object\") ?\n                                `${JSON.stringify(val)}` :\n                                    \"\");\n                            debug(valueStr);\n\n                            let title = \"\";\n                            let pubIndex = \"\";\n                            if (err.jsonPath && /^publications\\.[0-9]+/.test(err.jsonPath)) {\n                                const jsonPubTitlePath =\n                                    err.jsonPath.replace(/^(publications\\.[0-9]+).*/, \"$1.metadata.title\");\n                                debug(jsonPubTitlePath);\n                                title = DotProp.get(opds2FeedJson, jsonPubTitlePath);\n                                debug(title);\n\n                                pubIndex = err.jsonPath.replace(/^publications\\.([0-9]+).*/, \"$1\");\n                                debug(pubIndex);\n                            }\n\n                            validationStr +=\n                            // tslint:disable-next-line:max-line-length\n                            `\\n___________INDEX___________ #${pubIndex} \"${title}\"\\n\\n${err.ajvMessage}: ${valueStr}\\n\\n'${err.ajvDataPath?.replace(/^\\./, \"\")}' (${err.ajvSchemaPath})\\n\\n`;\n                        }\n                    }\n                }\n            }\n\n            const funk = (obj: any) => {\n                if ((obj.href && typeof obj.href === \"string\") ||\n                    (obj.Href && typeof obj.Href === \"string\")) {\n\n                    let fullHref = obj.href ? obj.href as string : obj.Href as string;\n\n                    const isDataUrl = /^data:/.test(fullHref);\n                    const isMailUrl = /^mailto:/.test(fullHref);\n                    const notFull = !isDataUrl && !isMailUrl && !isHTTP(fullHref);\n                    if (notFull) {\n                        fullHref = ensureAbsolute(urlDecoded, fullHref);\n                    }\n\n                    if ((obj.type && obj.type.indexOf(\"opds\") >= 0 && obj.type.indexOf(\"json\") >= 0) ||\n                        (obj.Type && obj.Type.indexOf(\"opds\") >= 0 && obj.Type.indexOf(\"json\") >= 0)) {\n\n                        obj.__href__ = rootUrl + req.originalUrl.substr(0,\n                            req.originalUrl.indexOf(serverOPDS_browse_v2_PATH + \"/\")) +\n                            serverOPDS_browse_v2_PATH + \"/\" + encodeURIComponent_RFC3986(fullHref);\n\n                        if (authRequestBase64 && authResponseBase64) {\n                            obj.__href__AUTH = obj.__href__ +\n                            \"?\" +\n                            _authResponse + \"=\" + encodeURIComponent_RFC3986(authResponseBase64) +\n                            \"&\" +\n                            _authRequest + \"=\" + encodeURIComponent_RFC3986(authRequestBase64)\n                            ;\n                        }\n                    } else if (obj.type === \"application/vnd.readium.lcp.license.v1.0+json\"\n                        // && obj.rel === \"http://opds-spec.org/acquisition\"\n                        ) {\n\n                        obj.__href__ = rootUrl + req.originalUrl.substr(0,\n                            req.originalUrl.indexOf(serverOPDS_browse_v2_PATH + \"/\")) +\n                            serverLCPLSD_show_PATH + \"/\" + encodeURIComponent_RFC3986(fullHref);\n\n                        if (authRequestBase64 && authResponseBase64) {\n                            obj.__href__AUTH = obj.__href__ +\n                            \"?\" +\n                            _authResponse + \"=\" + encodeURIComponent_RFC3986(authResponseBase64) +\n                            \"&\" +\n                            _authRequest + \"=\" + encodeURIComponent_RFC3986(authRequestBase64)\n                            ;\n                        }\n                    } else if ((obj.type && obj.type.indexOf(\"application/atom+xml\") >= 0) ||\n                        (obj.Type && obj.Type.indexOf(\"application/atom+xml\") >= 0)) {\n\n                        obj.__href__ = rootUrl + req.originalUrl.substr(0,\n                            req.originalUrl.indexOf(serverOPDS_browse_v2_PATH + \"/\")) +\n                            serverOPDS_convert_v1_to_v2_PATH + \"/\" + encodeURIComponent_RFC3986(fullHref);\n\n                    } else if (isDataUrl) {\n                        // obj.href = obj.href.substr(0, 100) + \"(...)\";\n                        // obj.__href__ = rootUrl + req.originalUrl.substr(0,\n                        //     req.originalUrl.indexOf(serverOPDS_browse_v2_PATH + \"/\")) +\n                        //     serverOPDS_dataUrl_PATH + \"/\" + encodeURIComponent_RFC3986(fullHref);\n\n                    } else if (notFull && !isMailUrl) {\n                        obj.__href__ = fullHref;\n                    }\n                }\n            };\n            traverseJsonObjects(opds2FeedJson, funk);\n\n            const css = css2json(jsonStyle);\n            let jsonPrettyOPDS2 = jsonMarkup(opds2FeedJson, css);\n            // tslint:disable-next-line: max-line-length\n            jsonPrettyOPDS2 = jsonPrettyOPDS2.replace(/>\"data:image\\/(.*)\"</g, \"><a href=\\\"data:image/$1\\\" target=\\\"_BLANK\\\"><img style=\\\"max-width: 100px;\\\" src=\\\"data:image/$1\\\"></a><\");\n\n            const authDoc = isAuth ? opds2Feed as OPDSAuthenticationDoc : undefined;\n            const authObj = (authDoc && authDoc.Authentication) ? authDoc.Authentication.find((auth) => {\n                return auth.Type === \"http://opds-spec.org/auth/oauth/password\";\n            }) : undefined;\n            const authLink = authObj ? (authObj.Links && authObj.Links.find((link) => {\n                return link.Rel && link.Rel.includes(\"authenticate\") && link.TypeLink === \"application/json\";\n            })) : undefined;\n            // const authLinkRefresh = authObj ? (authObj.Links && authObj.Links.find((link) => {\n            //     return link.Rel.includes(\"refresh\") && link.TypeLink === \"application/json\";\n            // })) : undefined;\n\n            const imageLink = authDoc ? (authDoc.Links && authDoc.Links.find((link) => {\n                return link.Rel && link.Rel.includes(\"logo\") && link.TypeLink && link.TypeLink.startsWith(\"image/\");\n            })) : undefined;\n            const imageUrl = imageLink ? ensureAbsolute(urlDecoded, imageLink.Href) : undefined;\n\n            const authHtmlForm = !authObj ? \"\" : `\n<hr>\n<form id=\"authForm\">\n    <input type=\"text\" name=\"login\" id=\"login\" size=\"40\">\n    <span>${authObj.Labels.Login}</span>\n<br><br>\n    <input type=\"password\" name=\"password\" id=\"password\" size=\"40\">\n    <span>${authObj.Labels.Password}</span>\n<br><br>\n    <input type=\"submit\" value=\"Authenticate\">\n</form>\n${imageUrl ? `<img src=\"${imageUrl}\" />` : ``}\n<script type=\"text/javascript\">\n// document.addEventListener(\"DOMContentLoaded\", (event) => {\n// });\nconst formElement = document.getElementById(\"authForm\");\nformElement.addEventListener(\"submit\", (event) => {\n    event.preventDefault();\n    doAuth();\n});\nfunction encodeURIComponent_RFC3986(str) {\n    return encodeURIComponent(str).replace(/[!'()*]/g, (c) => {\n        return \"%\" + c.charCodeAt(0).toString(16);\n    });\n}\nfunction encodeFormData(json) {\n    if (!json) {\n        return \"\";\n    }\n    return Object.keys(json).map((key) => {\n        return encodeURIComponent_RFC3986(key) + \"=\" + (json[key] ? encodeURIComponent_RFC3986(json[key]) : \"_\");\n    }).join(\"&\");\n}\nfunction hexStrToArrayBuffer(hexStr) {\n    return new Uint8Array(\n        hexStr\n        .match(/.{1,2}/g)\n        .map((byte) => {\n            return parseInt(byte, 16);\n        })\n    );\n}\nfunction doAuth() {\n    ${authLink ? `\n    const bodyJson = {\n        targetUrl: \"${urlDecoded}\",\n        authUrl: \"${authLink.Href}\",\n        grant_type: \"password\",\n        username: document.getElementById(\"login\").value,\n        password: document.getElementById(\"password\").value\n    };\n    const bodyStr = JSON.stringify(bodyJson);\n\n    const textEncoder = new TextEncoder(\"utf-8\");\n    const bodyStrEncoded = textEncoder.encode(bodyStr); // Uint8Array\n\n    const keyPromise = window.crypto.subtle.importKey(\n        \"raw\",\n        hexStrToArrayBuffer(\"${OPDS_AUTH_ENCRYPTION_KEY_HEX}\"),\n        { \"name\": \"AES-CBC\" },\n        false,\n        [\"encrypt\", \"decrypt\"]\n    );\n    keyPromise.then((key) => { // CryptoKey\n\n        const iv = hexStrToArrayBuffer(\"${OPDS_AUTH_ENCRYPTION_IV_HEX}\");\n        const encryptedBodyPromise = window.crypto.subtle.encrypt(\n            {\n                name: \"AES-CBC\",\n                iv\n            },\n            key,\n            bodyStrEncoded\n        );\n        encryptedBodyPromise.then((encryptedBody) => { // ArrayBuffer\n            // const arg = String.fromCharCode.apply(null, new Uint8Array(encryptedBody));\n            const arg = new Uint8Array(encryptedBody).reduce((data, byte) => {\n                return data + String.fromCharCode(byte);\n            }, '');\n            const encryptedBodyB64 = window.btoa(arg);\n\n            const url = location.origin + \"${serverOPDS_auth_PATH}/\" + encodeURIComponent_RFC3986(encryptedBodyB64);\n            location.href = url;\n        }).catch((err) => {\n            console.log(err);\n        });\n    }).catch((err) => {\n        console.log(err);\n    });\n\n/* does not work because of HTTP CORS, so we forward to NodeJS fetch/request via the serverOPDS_auth_PATH HTTP route\n    window.fetch(\"${authLink.Href}\", {\n        method: \"POST\",\n        headers: {\n            \"Content-Type\": \"application/x-www-form-url-encoded\",\n            \"Accept\": \"application/json\"\n        },\n        body: encodeFormData(bodyJson)\n    })\n    .then((response) => {\n        const res = JSON.stringify(response, null, 4);\n        console.log(res);\n    })\n    .catch((error) => {\n        console.log(error);\n    });\n*/\n    ` :\n    `window.alert(\"no auth link!\");`\n    }\n}\n</script>`;\n\n            res.status(200).send(\"<html><body>\" +\n                \"<h1>OPDS2 JSON \" +\n                (isPublication ? \"entry\" : (isAuth ? \"authentication\" : \"feed\")) +\n                \" (OPDS2) \" + (isAuthStatusCode ? \" [HTTP 401]\" : \"\") + \"</h1>\" +\n                \"<h2><a href=\\\"\" + urlDecoded + \"\\\">\" + urlDecoded + \"</a></h2>\" +\n                \"<hr>\" +\n                \"<div style=\\\"overflow-x: auto;margin:0;padding:0;width:100%;height:auto;\\\">\" +\n                jsonPrettyOPDS2 + \"</div>\" +\n                // tslint:disable-next-line:max-line-length\n                (doValidate ? (validationStr ? (\"<hr><p><pre>\" + validationStr + \"</pre></p>\") : (\"<hr><p>JSON SCHEMA OK.</p>\")) : \"\") +\n                authHtmlForm +\n                // \"<p><pre>\" + jsonPretty + \"</pre></p>\" +\n                // \"<hr><p><pre>\" + jsonStr + \"</pre></p>\" +\n                // \"<p><pre>\" + dumpStr + \"</pre></p>\" +\n                \"</body></html>\");\n        };\n\n        const headers = {\n            \"Accept\": \"application/json,application/xml\",\n            \"Accept-Language\": \"en-UK,en-US;q=0.7,en;q=0.5\",\n            \"User-Agent\": \"READIUM2\",\n        };\n\n        if (authResponseJson && authResponseJson.access_token) {\n            (headers as any).Authorization = `Bearer ${authResponseJson.access_token}`;\n        }\n\n        // No response streaming! :(\n        // https://github.com/request/request-promise/issues/90\n        const needsStreamingResponse = true;\n        if (needsStreamingResponse) {\n            request.get({\n                headers,\n                method: \"GET\",\n                uri: urlDecoded,\n            })\n                .on(\"response\", success)\n                .on(\"error\", failure);\n        } else {\n            let response: requestPromise.FullResponse;\n            try {\n                // tslint:disable-next-line:await-promise no-floating-promises\n                response = await requestPromise({\n                    headers,\n                    method: \"GET\",\n                    resolveWithFullResponse: true,\n                    uri: urlDecoded,\n                });\n            } catch (err) {\n                failure(err);\n                return;\n            }\n\n            await success(response);\n        }\n    });\n\n    topRouter.use(serverOPDS_browse_v2_PATH, routerOPDS_browse_v2);\n\n    // -------------------------------------------------------\n\n    // // tslint:disable-next-line:variable-name\n    // const routerOPDS_dataUrl = express.Router({ strict: false });\n    // routerOPDS_dataUrl.use(morgan(\"combined\", { stream: { write: (msg: any) => debug(msg) } }));\n\n    // routerOPDS_dataUrl.use(trailingSlashRedirect);\n\n    // routerOPDS_dataUrl.get(\"/\", (_req: express.Request, res: express.Response) => {\n\n    //     let html = \"<html><head>\";\n    //     html += `<script type=\"text/javascript\">function encodeURIComponent_RFC3986(str) { ` +\n    //         `return encodeURIComponent(str).replace(/[!'()*]/g, (c) => { ` +\n    //         `return \"%\" + c.charCodeAt(0).toString(16); }); }` +\n    //         `function go(evt) {` +\n    //         `if (evt) { evt.preventDefault(); } var url = ` +\n    //         `location.origin +` +\n    //         // `location.protocol + '//' + location.hostname + ` +\n    //         // `(location.port ? (':' + location.port) : '') + ` +\n    //         ` '${serverOPDS_dataUrl_PATH}/' +` +\n    //         ` encodeURIComponent_RFC3986(document.getElementById(\"url\").value);` +\n    //         `location.href = url;}</script>`;\n    //     html += \"</head>\";\n\n    //     html += \"<body><h1>data URL viewer</h1>\";\n\n    //     html += `<form onsubmit=\"go();return false;\">` +\n    //         `<input type=\"text\" name=\"url\" id=\"url\" size=\"80\">` +\n    //         `<input type=\"submit\" value=\"Go!\"></form>`;\n\n    //     html += \"</body></html>\";\n\n    //     res.status(200).send(html);\n    // });\n\n    // routerOPDS_dataUrl.param(\"urlEncoded\", (req, _res, next, value, _name) => {\n    //     (req as IRequestPayloadExtension).urlEncoded = value;\n    //     next();\n    // });\n\n    // routerOPDS_dataUrl.get(\"/:\" + _urlEncoded + \"(*)\", async (req: express.Request, res: express.Response) => {\n\n    //     const reqparams = (req as IRequestPayloadExtension).params;\n\n    //     if (!reqparams.urlEncoded) {\n    //         reqparams.urlEncoded = (req as IRequestPayloadExtension).urlEncoded;\n    //     }\n\n    //     const urlDecoded = reqparams.urlEncoded;\n    //     // if (urlDecoded.substr(-1) === \"/\") {\n    //     //     urlDecoded = urlDecoded.substr(0, urlDecoded.length - 1);\n    //     // }\n    //     debug(urlDecoded);\n\n    //     res.status(200).send(\"<html><body>\" +\n    //         \"<h1>DATA URL</h1>\" +\n    //         \"<h2><a href=\\\"\" + urlDecoded + \"\\\">\" + urlDecoded + \"</a></h2>\" +\n    //         \"<hr>\" +\n    //         \"<img src=\\\"\" + urlDecoded + \"\\\" />\" +\n    //         \"</body></html>\");\n    // });\n\n    // topRouter.use(serverOPDS_dataUrl_PATH, routerOPDS_dataUrl);\n\n    // -------------------------------------------------------\n\n    // tslint:disable-next-line:variable-name\n    const routerOPDS_auth = express.Router({ strict: false });\n    routerOPDS_auth.use(morgan(\"combined\", { stream: { write: (msg: any) => debug(msg) } }));\n\n    routerOPDS_auth.use(trailingSlashRedirect);\n\n    routerOPDS_auth.get(\"/\", (_req: express.Request, res: express.Response) => {\n\n        const html = \"<html><body><h1>NOPE</h1></body></html>\";\n        res.status(200).send(html);\n    });\n\n    routerOPDS_auth.param(\"urlEncoded\", (req, _res, next, value, _name) => {\n        (req as IRequestPayloadExtension).urlEncoded = value;\n        next();\n    });\n\n    routerOPDS_auth.get(\"/:\" + _urlEncoded + \"(*)\", async (req: express.Request, res: express.Response) => {\n\n        const reqparams = (req as IRequestPayloadExtension).params;\n\n        if (!reqparams.urlEncoded) {\n            reqparams.urlEncoded = (req as IRequestPayloadExtension).urlEncoded;\n        }\n\n        const base64Payload = reqparams.urlEncoded;\n\n        const refreshToken = (req.query as IRequestQueryParams).authRefresh;\n\n        const isSecureHttp = req.secure ||\n            req.protocol === \"https\" ||\n            req.get(\"X-Forwarded-Proto\") === \"https\"\n            ;\n        const rootUrl = (isSecureHttp ? \"https://\" : \"http://\")\n            + req.headers.host;\n\n        try {\n            const encrypted = Buffer.from(base64Payload, \"base64\"); // .toString(\"utf8\");\n\n            const decrypteds: Buffer[] = [];\n            const decryptStream = crypto.createDecipheriv(\"aes-256-cbc\",\n                OPDS_AUTH_ENCRYPTION_KEY_BUFFER,\n                OPDS_AUTH_ENCRYPTION_IV_BUFFER);\n            decryptStream.setAutoPadding(false);\n            const buff1 = decryptStream.update(encrypted);\n            if (buff1) {\n                decrypteds.push(buff1);\n            }\n            const buff2 = decryptStream.final();\n            if (buff2) {\n                decrypteds.push(buff2);\n            }\n            const decrypted = Buffer.concat(decrypteds);\n            const nPaddingBytes = decrypted[decrypted.length - 1];\n            const size = encrypted.length - nPaddingBytes;\n            const decryptedStr = decrypted.slice(0, size).toString(\"utf8\");\n            const decryptedJson = JSON.parse(decryptedStr);\n\n            const authUrl = decryptedJson.authUrl;\n            delete decryptedJson.authUrl;\n\n            const targetUrl = decryptedJson.targetUrl;\n            delete decryptedJson.targetUrl;\n\n            // https://www.oauth.com/oauth2-servers/making-authenticated-requests/refreshing-an-access-token/\n            if (refreshToken) {\n                decryptedJson.grant_type = \"refresh_token\";\n                decryptedJson.refresh_token = refreshToken;\n            }\n\n            // const grantType = decryptedJson.grant_type;\n            // const username = decryptedJson.username;\n            // const password = decryptedJson.password;\n\n            // function encodeFormData(json: any) {\n            //     return Object.keys(json).map((key) => {\n            //         return encodeURIComponent_RFC3986(key) +\n            //             \"=\" + (json[key] ? encodeURIComponent_RFC3986(json[key]) : \"_\");\n            //     }).join(\"&\");\n            // }\n            // const encodedFormData = encodeFormData(decryptedJson);\n\n            const failure = (err: any) => {\n                debug(err);\n                res.status(500).send(\"<html><body><p>Internal Server Error</p><p>\"\n                    + err + \"</p></body></html>\");\n            };\n\n            const success = async (response: request.RequestResponse) => {\n\n                // Object.keys(response.headers).forEach((header: string) => {\n                //     debug(header + \" => \" + response.headers[header]);\n                // });\n\n                if (response.statusCode && (response.statusCode < 200 || response.statusCode >= 300)) {\n                    failure(\"HTTP CODE \" + response.statusCode);\n                    return;\n                }\n\n                let responseData: Buffer;\n                try {\n                    responseData = await streamToBufferPromise(response);\n                } catch (err) {\n                    debug(err);\n                    res.status(500).send(\"<html><body><p>Internal Server Error</p><p>\"\n                        + err + \"</p></body></html>\");\n                    return;\n                }\n                try {\n                    const responseStr = responseData.toString(\"utf8\");\n                    const responseJson = JSON.parse(responseStr);\n                    // {\n                    //     \"access_token\": \"XXX\",\n                    //     \"token_type\": \"Bearer\",\n                    //     \"expires_in\": 3600,\n                    //     \"refresh_token\": \"YYYY\",\n                    //     \"created_at\": 1574940691\n                    // }\n                    const targetUrl_ = rootUrl + req.originalUrl.substr(0,\n                        req.originalUrl.indexOf(serverOPDS_auth_PATH + \"/\")) +\n                        serverOPDS_browse_v2_PATH + \"/\" + encodeURIComponent_RFC3986(targetUrl) +\n                        \"?\" + _authResponse + \"=\" +\n                        encodeURIComponent_RFC3986(Buffer.from(JSON.stringify(responseJson)).toString(\"base64\")) +\n                        \"&\" + _authRequest + \"=\" + encodeURIComponent_RFC3986(base64Payload);\n\n                    const refreshTokenUrl = responseJson.refresh_token ? rootUrl + req.originalUrl.substr(0,\n                        req.originalUrl.indexOf(serverOPDS_auth_PATH + \"/\")) +\n                        serverOPDS_auth_PATH + \"/\" + encodeURIComponent_RFC3986(base64Payload) +\n                        \"?\" + _authRefresh + \"=\" + encodeURIComponent_RFC3986(responseJson.refresh_token) : undefined;\n\n                    decryptedJson.password = \"***\";\n                    res.status(200).send(`\n                        <html><body>\n                        <hr>\n                        <a href=\"${targetUrl_}\">${targetUrl}</a>\n                        <hr>\n                        <pre>${JSON.stringify(decryptedJson, null, 4)}</pre>\n                        <hr>\n                        <pre>${JSON.stringify(responseJson, null, 4)}</pre>\n                        <hr>\n                        ${refreshTokenUrl ? `<a href=\"${refreshTokenUrl}\">FORCE REFRESH TOKEN</a>` : \"\"}\n                        <hr>\n                        </body></html>\n                    `);\n                } catch (err) {\n                    debug(err);\n                    res.status(500).send(\"<html><body><p>Internal Server Error</p><p>\"\n                        + err + \"</p></body></html>\");\n                    return;\n                }\n            };\n\n            const headers = {\n                \"Accept\": \"application/json,application/xml\",\n                \"Accept-Language\": \"en-UK,en-US;q=0.7,en;q=0.5\",\n                \"Content-Type\": \"application/x-www-form-url-encoded\",\n                \"User-Agent\": \"READIUM2\",\n            };\n\n            // No response streaming! :(\n            // https://github.com/request/request-promise/issues/90\n            const needsStreamingResponse = true;\n            if (needsStreamingResponse) {\n                request.post({\n                    form: decryptedJson,\n                    headers,\n                    method: \"POST\",\n                    uri: authUrl,\n                })\n                    .on(\"response\", success)\n                    .on(\"error\", failure);\n            } else {\n                let response: requestPromise.FullResponse;\n                try {\n                    // tslint:disable-next-line:await-promise no-floating-promises\n                    response = await requestPromise({\n                        form: decryptedJson,\n                        headers,\n                        method: \"POST\",\n                        resolveWithFullResponse: true,\n                        uri: authUrl,\n                    });\n                } catch (err) {\n                    failure(err);\n                    return;\n                }\n\n                await success(response);\n            }\n        } catch (err) {\n            debug(err);\n\n            res.status(500).send(\"<html><body><p>Internal Server Error</p><p>\"\n            + \"--\" + \"</p></body></html>\");\n        }\n    });\n\n    topRouter.use(serverOPDS_auth_PATH, routerOPDS_auth);\n}\n"]}